{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people-fill text-primary"></i> Gestão de Pacientes</h2>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white pt-3 pb-3">
                <h5 class="mb-0"><i class="bi bi-lightning-charge-fill"></i> Cadastro Rápido</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">Preencha apenas o nome para agilizar. Complete o resto depois.</p>
                
                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nome Completo</label>
                        <div class="input-group">
                            <input type="text" id="nomePaciente" name="nome" class="form-control" placeholder="Fale ou digite..." required>
                            <button class="btn btn-outline-primary" type="button" id="btnVoiceName">
                                <i class="bi bi-mic-fill"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Data de Nascimento <span class="text-muted small">(Opcional)</span></label>
                        <input type="date" name="nascimento" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Telefone <span class="text-muted small">(Opcional)</span></label>
                        <input type="text" name="telefone" class="form-control" placeholder="(xx) 9...">
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-person-plus-fill"></i> Cadastrar Agora
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title text-muted mb-0">Base de Pacientes</h5>
                    <span class="badge bg-light text-dark">{{ pacientes|length }} cadastrados</span>
                </div>
                
                {% if pacientes %}
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Nome</th>
                                <th>Idade</th>
                                <th>Contato</th>
                                <th class="text-end" style="width: 160px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in pacientes %}
                            <tr>
                                <td class="fw-bold text-primary">{{ p[1] }}</td> <td>
                                    {% if p[2] != "---" %}
                                        <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">{{ p[2] }}</span>
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ p[3] if p[3] else '' }}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-info text-white me-1" title="Prontuário / Evolução" 
                                            onclick="window.location.href='{{ url_for('prontuarios') }}'">
                                        <i class="bi bi-clipboard2-pulse-fill"></i>
                                    </button>
                                    
                                    <button class="btn btn-sm btn-outline-danger" title="Excluir Paciente" onclick="excluirPaciente({{ p[0] }}, '{{ p[1] }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <div class="alert alert-light text-center py-5 border border-dashed">
                        <i class="bi bi-people fs-1 text-muted opacity-50"></i>
                        <p class="mt-2 text-muted">Nenhum paciente na base.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // --- FUNÇÃO DE EXCLUIR REFORÇADA ---
    function excluirPaciente(id, nome) {
        if (confirm(`ATENÇÃO: Tem certeza que deseja excluir ${nome}?\n\nIsso apagará:\n- Todo o histórico de consultas\n- Prontuários e Evoluções\n- Avaliações e Fotos`)) {
            
            // Feedback visual imediato (Opcional: muda cursor para aguarde)
            document.body.style.cursor = 'wait';

            fetch('/api/deletar_paciente', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: id })
            })
            .then(response => response.json())
            .then(data => {
                document.body.style.cursor = 'default';
                
                if (data.status === 'success') {
                    // Força o recarregamento da página vindo do servidor, ignorando cache
                    window.location.href = window.location.href;
                } else {
                    alert('ERRO DO SISTEMA: ' + (data.message || 'Erro desconhecido ao excluir.'));
                }
            })
            .catch(error => {
                document.body.style.cursor = 'default';
                console.error('Error:', error);
                alert('Erro de conexão com o servidor. Tente novamente.');
            });
        }
    }

    // --- RECONHECIMENTO DE VOZ ---
    const btnVoiceName = document.getElementById('btnVoiceName');
    const inputNome = document.getElementById('nomePaciente');

    if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'pt-BR';
        recognition.continuous = false;

        btnVoiceName.addEventListener('click', () => {
            recognition.start();
            btnVoiceName.classList.remove('btn-outline-primary');
            btnVoiceName.classList.add('btn-danger'); 
            btnVoiceName.innerHTML = '<i class="bi bi-record-circle-fill"></i>';
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            const nomeFormatado = transcript.toLowerCase().replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());
            inputNome.value = nomeFormatado;
            btnVoiceName.classList.remove('btn-danger');
            btnVoiceName.classList.add('btn-outline-primary');
            btnVoiceName.innerHTML = '<i class="bi bi-mic-fill"></i>';
        };
        
        recognition.onend = () => {
            if(btnVoiceName.classList.contains('btn-danger')) {
                 btnVoiceName.classList.remove('btn-danger');
                 btnVoiceName.classList.add('btn-outline-primary');
                 btnVoiceName.innerHTML = '<i class="bi bi-mic-fill"></i>';
            }
        };
    } else {
        btnVoiceName.style.display = 'none';
    }
</script>
{% endblock %}