{% extends "layout.html" %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
    <h2 class="brand-title mb-3 mb-md-0"><i class="bi bi-journal-medical text-primary me-2"></i> Prontu√°rio</h2>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-2">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
            <input type="text" id="filtroPaciente" class="form-control border-start-0" placeholder="Buscar paciente..." onkeyup="filtrarLista()">
        </div>
    </div>
</div>

<div class="row g-3" id="listaPacientesCards">
    {% for p in pacientes %}
    <div class="col-12 col-md-4 item-paciente">
        <div class="card h-100 border-0 shadow-sm hover-card">
            <div class="card-body d-flex flex-row flex-md-column align-items-center text-center p-3">
                <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3 me-md-0 mb-md-3 text-primary">
                    <i class="bi bi-person-fill fs-3"></i>
                </div>
                <div class="text-start text-md-center flex-grow-1">
                    <h5 class="card-title fw-bold text-dark mb-1 nome-paciente">{{ p[1] }}</h5>
                    <p class="text-muted small mb-0"><i class="bi bi-cake2"></i> {% if p[2] %} {{ p[2].strftime('%d/%m/%Y') }} {% else %} --/--/-- {% endif %}</p>
                </div>
                <button class="btn btn-primary rounded-pill ms-2 ms-md-0 mt-md-3" onclick="abrirProntuario({{ p[0] }}, '{{ p[1] }}')">
                    <i class="bi bi-folder2-open"></i> <span class="d-none d-md-inline">Abrir</span>
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5"><p class="text-muted">Nenhum paciente encontrado.</p></div>
    {% endfor %}
</div>

<div class="modal fade" id="modalProntuario" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title fs-6"><i class="bi bi-clipboard2-pulse"></i> <span id="tituloProntuario" class="fw-bold"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body bg-light p-2">
                <input type="hidden" id="idPacienteProntuario">

                <ul class="nav nav-pills nav-fill mb-3 gap-1" id="prontuarioTabs" role="tablist">
                    <li class="nav-item"><button class="nav-link active btn-sm" data-bs-toggle="tab" data-bs-target="#tab-evolucao"><i class="bi bi-list-check"></i> Evolu√ß√£o</button></li>
                    <li class="nav-item"><button class="nav-link btn-sm" data-bs-toggle="tab" data-bs-target="#tab-avaliacao"><i class="bi bi-person-lines-fill"></i> Avalia√ß√£o</button></li>
                    <li class="nav-item"><button class="nav-link btn-sm" data-bs-toggle="tab" data-bs-target="#tab-postural"><i class="bi bi-camera-fill"></i> Fotos</button></li>
                </ul>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-evolucao">
                        <div class="row g-2">
                            <div class="col-12 col-md-5 order-md-1 mb-2">
                                <div class="bg-white p-2 rounded shadow-sm">
                                    <h6 class="text-primary fw-bold mb-2">Nova Evolu√ß√£o</h6>
                                    <div class="input-group mb-2">
                                        <textarea id="textoEvolucao" class="form-control" rows="5" placeholder="Relate o procedimento..."></textarea>
                                        <button class="btn btn-outline-secondary" type="button" id="btnVoiceEvo"><i class="bi bi-mic-fill fs-4"></i></button>
                                    </div>
                                    <button onclick="salvarEvolucao()" class="btn btn-success w-100 py-2"><i class="bi bi-save"></i> Salvar Evolu√ß√£o</button>
                                </div>
                            </div>
                            <div class="col-12 col-md-7 order-md-2">
                                <h6 class="text-muted fw-bold mb-2">Hist√≥rico</h6>
                                <div id="listaHistorico" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-avaliacao">
                        <div class="accordion" id="accordionAvaliacao">
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button fw-bold text-primary py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">I. Anamnese</button></h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionAvaliacao">
                                    <div class="accordion-body p-2">
                                        
                                        <div class="alert alert-danger mb-3 p-2 shadow-sm">
                                            <h6 class="alert-heading fw-bold small mb-2"><i class="bi bi-exclamation-triangle-fill"></i> Red Flags</h6>
                                            <div class="row g-2">
                                                <div class="col-6 col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start text-truncate" onclick="addRedFlag('Perda de peso')">üìâ Perda peso</button></div>
                                                <div class="col-6 col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start text-truncate" onclick="addRedFlag('Dor noturna')">üåô Dor noturna</button></div>
                                                <div class="col-6 col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start text-truncate" onclick="addRedFlag('Hist√≥rico C√¢ncer')">üéóÔ∏è C√¢ncer</button></div>
                                                <div class="col-6 col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start text-truncate" onclick="addRedFlag('Febre/Infec√ß√£o')">üå°Ô∏è Febre</button></div>
                                                <div class="col-6 col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start text-truncate" onclick="addRedFlag('D√©ficit Neuro')">üß† Neuro</button></div>
                                                <div class="col-6 col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start text-truncate" onclick="addRedFlag('Bexiga/Intestino')">üöΩ Bexiga</button></div>
                                            </div>
                                        </div>

                                        <div class="row g-2 mb-2">
                                            <div class="col-12 col-md-4"><input type="text" id="avOcupacao" class="form-control form-control-sm" placeholder="Ocupa√ß√£o"></div>
                                            <div class="col-6 col-md-4"><select id="avLateralidade" class="form-select form-select-sm"><option>Destro</option><option>Canhoto</option><option>Ambidestro</option></select></div>
                                            <div class="col-6 col-md-4"><input type="text" id="avDiagMedico" class="form-control form-control-sm" placeholder="Diag. M√©dico"></div>
                                        </div>

                                        <div class="mb-2">
                                            <label class="small fw-bold">Queixa Principal (QP)</label>
                                            <div class="input-group input-group-sm"><input type="text" id="avQP" class="form-control"><button class="btn btn-outline-secondary" onclick="startVoice('avQP', this)"><i class="bi bi-mic-fill"></i></button></div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="small fw-bold">HDA (Hist√≥ria Doen√ßa Atual)</label>
                                            <div class="input-group input-group-sm"><textarea id="avHMA" class="form-control" rows="3"></textarea><button class="btn btn-outline-secondary" onclick="startVoice('avHMA', this)"><i class="bi bi-mic-fill"></i></button></div>
                                        </div>

                                        <div class="p-2 bg-light rounded border mb-3">
                                            <label class="small fw-bold">Comorbidades (HPP)</label>
                                            <div class="row g-2 mb-2">
                                                <div class="col-12 col-md-4"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" disabled selected>üß† Neurol√≥gicas...</option><option value="AVC">AVC</option><option value="Parkinson">Parkinson</option><option value="Alzheimer">Alzheimer</option><option value="Esclerose M√∫ltipla">Esclerose M√∫ltipla</option></select></div>
                                                <div class="col-6 col-md-4"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" disabled selected>‚öñÔ∏è Metab√≥licas...</option><option value="Diabetes">Diabetes</option><option value="Hipertens√£o">Hipertens√£o</option><option value="Obesidade">Obesidade</option></select></div>
                                                <div class="col-6 col-md-4"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" disabled selected>ü¶¥ Ortop√©dicas...</option><option value="Artrose">Artrose</option><option value="Fratura">Fratura</option><option value="H√©rnia de Disco">H√©rnia de Disco</option></select></div>
                                                <div class="col-6 col-md-6"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" disabled selected>‚ù§Ô∏è Cardiovasculares...</option><option value="Insufici√™ncia Card√≠aca">Insufici√™ncia Card√≠aca</option><option value="Arritmias">Arritmias</option><option value="DAC">DAC</option></select></div>
                                                <div class="col-6 col-md-6"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" disabled selected>ü´Å Respirat√≥rias...</option><option value="Asma">Asma</option><option value="DPOC">DPOC</option><option value="Pneumonia">Pneumonia</option></select></div>
                                            </div>
                                            <div class="input-group input-group-sm"><textarea id="avHPP" class="form-control" rows="2"></textarea><button class="btn btn-outline-secondary" onclick="startVoice('avHPP', this)"><i class="bi bi-mic-fill"></i></button></div>
                                        </div>

                                        <div class="p-2 border rounded bg-light">
                                            <label class="small fw-bold text-primary">H√°bitos de Vida</label>
                                            <div class="row g-2">
                                                <div class="col-12 col-md-4"><select id="selAtividade" class="form-select form-select-sm" onchange="gerarTextoHabitos()"><option>Sedent√°rio</option><option>Leve</option><option>Moderada</option><option>Intensa</option></select></div>
                                                <div class="col-6 col-md-4"><select id="selEtilismo" class="form-select form-select-sm" onchange="gerarTextoHabitos()"><option>Nega Etilismo</option><option>Social</option><option>Moderado</option></select></div>
                                                <div class="col-6 col-md-4"><select id="selTabagismo" class="form-select form-select-sm" onchange="toggleTabagismo()"><option>Nega Tabagismo</option><option>Ex-tabagista</option><option>Tabagista</option></select></div>
                                            </div>
                                            <div id="divCargaTabagica" class="mt-2 p-2 bg-warning-subtle rounded d-none border border-warning">
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-4"><input type="number" inputmode="numeric" id="numCigarros" class="form-control form-control-sm" placeholder="Cigs/dia" value="20" oninput="gerarTextoHabitos()"></div>
                                                    <div class="col-4"><input type="number" inputmode="numeric" id="numAnosFumo" class="form-control form-control-sm" placeholder="Anos" value="10" oninput="gerarTextoHabitos()"></div>
                                                    <div class="col-4 text-end"><span class="badge bg-danger" id="resCargaTabagica">--</span></div>
                                                </div>
                                            </div>
                                            <textarea id="avHabitos" class="form-control form-control-sm mt-2 bg-white" rows="2" readonly></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold text-primary py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">II. Exame F√≠sico</button></h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionAvaliacao">
                                    <div class="accordion-body p-2">
                                        
                                        <div class="mb-3"><label class="small fw-bold">Sinais Vitais</label>
                                            <div class="input-group input-group-sm">
                                                <input type="tel" class="form-control" id="sinPA" placeholder="PA"><span class="input-group-text px-1">/</span>
                                                <input type="tel" class="form-control" id="sinFC" placeholder="FC"><span class="input-group-text px-1">/</span>
                                                <input type="tel" class="form-control" id="sinSpO2" placeholder="SpO2"><span class="input-group-text px-1">/</span>
                                                <input type="tel" class="form-control" id="sinTemp" placeholder="Temp">
                                            </div>
                                        </div>

                                        <div class="mb-3 p-2 bg-light border rounded">
                                            <label class="small fw-bold">Dor</label>
                                            <div class="row g-2 mb-2">
                                                <div class="col-3"><input type="number" inputmode="numeric" id="dorEVA" class="form-control form-control-sm" placeholder="EVA"></div>
                                                <div class="col-9"><input type="text" id="dorLocal" class="form-control form-control-sm" placeholder="Local"></div>
                                            </div>
                                            <div class="row g-2">
                                                <div class="col-12"><select id="dorTipo" class="form-select form-select-sm"><option value="">Tipo...</option><option>Pontada</option><option>Queima√ß√£o</option><option>Puls√°til</option><option>Cansa√ßo</option><option>Choque</option></select></div>
                                                <div class="col-6"><input type="text" id="dorPiora" class="form-control form-control-sm" placeholder="Piora..."></div>
                                                <div class="col-6"><input type="text" id="dorAlivio" class="form-control form-control-sm" placeholder="Alivia..."></div>
                                            </div>
                                        </div>

                                        <div class="row g-2 mb-3">
                                            <div class="col-12"><textarea id="avInspecao" class="form-control form-control-sm" rows="1" placeholder="Inspe√ß√£o"></textarea></div>
                                            <div class="col-12"><textarea id="avPalpacao" class="form-control form-control-sm" rows="1" placeholder="Palpa√ß√£o"></textarea></div>
                                        </div>

                                        <div class="card border-primary mb-3">
                                            <div class="card-header bg-primary text-white py-1 fw-bold small"><i class="bi bi-arrows-angle-expand"></i> Goniometria</div>
                                            <div class="card-body p-2 bg-light">
                                                <div class="row g-1 mb-2">
                                                    <div class="col-12"><select id="gonioRegiao" class="form-select form-select-sm" onchange="atualizarArticulacoes()"><option value="" disabled selected>1. Regi√£o</option><option value="coluna">Coluna Vertebral</option><option value="superior">Membros Superiores</option><option value="inferior">Membros Inferiores</option></select></div>
                                                    <div class="col-6"><select id="gonioArticulacao" class="form-select form-select-sm" onchange="atualizarMovimentos()" disabled><option value="" selected>2. Articula√ß√£o</option></select></div>
                                                    <div class="col-6"><select id="gonioMovimento" class="form-select form-select-sm" onchange="atualizarGraus()" disabled><option value="" selected>3. Movimento</option></select></div>
                                                    
                                                    <div class="col-6">
                                                        <div class="btn-group w-100" role="group">
                                                            <input type="radio" class="btn-check" name="gonioLat" id="gLatD" value="D" checked><label class="btn btn-outline-primary btn-sm" for="gLatD">Dir</label>
                                                            <input type="radio" class="btn-check" name="gonioLat" id="gLatE" value="E"><label class="btn btn-outline-primary btn-sm" for="gLatE">Esq</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="btn-group w-100"><input type="radio" class="btn-check" name="gonioTipo" id="btnAtiva" value="Ativa" checked><label class="btn btn-outline-primary btn-sm" for="btnAtiva">Ativa</label><input type="radio" class="btn-check" name="gonioTipo" id="btnPassiva" value="Passiva"><label class="btn btn-outline-primary btn-sm" for="btnPassiva">Passiva</label></div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row g-1 align-items-center">
                                                    <div class="col-12"><select id="gonioGraus" class="form-select form-select-sm" disabled><option value="" selected>4. Selecione o Grau</option></select></div>
                                                    <div class="col-6"><div class="form-check pt-1"><input class="form-check-input" type="checkbox" id="gonioDor"><label class="form-check-label small fw-bold text-danger" for="gonioDor">Com Dor</label></div></div>
                                                    <div class="col-6"><button type="button" class="btn btn-success btn-sm w-100" onclick="adicionarGoniometria()">Adicionar</button></div>
                                                </div>
                                                <ul id="listaGoniometria" class="list-group mt-2 small"></ul>
                                                <textarea id="avADM" class="d-none"></textarea>
                                            </div>
                                        </div>

                                        <div class="card border-success mb-3">
                                            <div class="card-header bg-success text-white py-1 fw-bold small"><i class="bi bi-activity"></i> For√ßa Muscular (MRC)</div>
                                            <div class="card-body p-2 bg-light">
                                                <div class="row g-1 mb-2">
                                                    <div class="col-12"><select id="forcaRegiao" class="form-select form-select-sm" onchange="atualizarMusculosForca()"><option value="" disabled selected>1. Regi√£o</option><option value="superior">Membros Superiores</option><option value="inferior">Membros Inferiores</option><option value="tronco">Tronco/Coluna</option></select></div>
                                                    <div class="col-12"><select id="forcaMusculo" class="form-select form-select-sm" disabled><option value="" selected>2. M√∫sculo</option></select></div>
                                                    
                                                    <div class="col-4">
                                                        <div class="btn-group w-100" role="group">
                                                            <input type="radio" class="btn-check" name="forcaLat" id="fLatD" value="D" checked><label class="btn btn-outline-success btn-sm" for="fLatD">D</label>
                                                            <input type="radio" class="btn-check" name="forcaLat" id="fLatE" value="E"><label class="btn btn-outline-success btn-sm" for="fLatE">E</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-8"><select id="forcaGrau" class="form-select form-select-sm" disabled><option value="" selected>3. Grau (0-5)</option><option value="0 - Plegia">0 - Plegia</option><option value="1 - Contra√ß√£o">1 - Contra√ß√£o</option><option value="2 - S/ Gravidade">2 - S/ Gravidade</option><option value="3 - Vence Gravidade">3 - Vence Gravidade</option><option value="4 - Resist√™ncia">4 - Resist√™ncia</option><option value="5 - Normal">5 - Normal</option></select></div>
                                                </div>
                                                <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="adicionarForca()">Adicionar For√ßa</button>
                                                <ul id="listaForca" class="list-group mt-2 small"></ul>
                                                <textarea id="avForca" class="d-none"></textarea>
                                            </div>
                                        </div>

                                        <div class="row g-2 mb-3"><div class="col-12"><label class="small fw-bold">Testes Especiais</label><textarea id="avTestes" class="form-control form-control-sm" rows="2"></textarea></div></div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold text-primary py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">III. Conduta</button></h2>
                                <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionAvaliacao">
                                    <div class="accordion-body p-2">
                                        <div class="mb-2"><label class="small fw-bold">Diagn√≥stico (CIF)</label><textarea id="avCIF" class="form-control form-control-sm" rows="2"></textarea></div>
                                        <div class="mb-2"><label class="small fw-bold">Objetivos</label><textarea id="avObjetivos" class="form-control form-control-sm" rows="2"></textarea></div>
                                        <div class="mb-2"><label class="small fw-bold">Conduta</label><textarea id="avConduta" class="form-control form-control-sm" rows="2"></textarea></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="d-grid mt-3">
                            <button type="button" onclick="salvarAvaliacao()" class="btn btn-primary btn-lg"><i class="bi bi-file-earmark-medical"></i> Salvar Avalia√ß√£o Completa</button>
                            <small class="text-muted text-center mt-2" id="dataUltimaAvaliacao">Carregando...</small>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-postural">
                        <div class="alert alert-info py-2 small">Clique no √≠cone para abrir a c√¢mera.</div>
                        <div class="row g-2 text-center mb-3">
                            <div class="col-6">
                                <div class="card bg-light h-100" onclick="document.getElementById('fileFrontal').click()">
                                    <div class="card-body p-1 d-flex align-items-center justify-content-center" style="height:120px">
                                        <img id="imgFrontal" class="d-none mw-100 mh-100"><i id="iconFrontal" class="bi bi-person fs-1 text-secondary"></i>
                                    </div>
                                    <div class="card-footer p-1 small fw-bold">Frontal</div>
                                    <input type="file" id="fileFrontal" accept="image/*" capture="environment" hidden onchange="processarImagem(this,'imgFrontal','iconFrontal')">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light h-100" onclick="document.getElementById('filePosterior').click()">
                                    <div class="card-body p-1 d-flex align-items-center justify-content-center" style="height:120px">
                                        <img id="imgPosterior" class="d-none mw-100 mh-100"><i id="iconPosterior" class="bi bi-person fs-1 text-secondary"></i>
                                    </div>
                                    <div class="card-footer p-1 small fw-bold">Posterior</div>
                                    <input type="file" id="filePosterior" accept="image/*" capture="environment" hidden onchange="processarImagem(this,'imgPosterior','iconPosterior')">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light h-100" onclick="document.getElementById('fileLatDir').click()">
                                    <div class="card-body p-1 d-flex align-items-center justify-content-center" style="height:120px">
                                        <img id="imgLatDir" class="d-none mw-100 mh-100"><i id="iconLatDir" class="bi bi-arrow-right fs-1 text-secondary"></i>
                                    </div>
                                    <div class="card-footer p-1 small fw-bold">Lat. Dir</div>
                                    <input type="file" id="fileLatDir" accept="image/*" capture="environment" hidden onchange="processarImagem(this,'imgLatDir','iconLatDir')">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light h-100" onclick="document.getElementById('fileLatEsq').click()">
                                    <div class="card-body p-1 d-flex align-items-center justify-content-center" style="height:120px">
                                        <img id="imgLatEsq" class="d-none mw-100 mh-100"><i id="iconLatEsq" class="bi bi-arrow-left fs-1 text-secondary"></i>
                                    </div>
                                    <div class="card-footer p-1 small fw-bold">Lat. Esq</div>
                                    <input type="file" id="fileLatEsq" accept="image/*" capture="environment" hidden onchange="processarImagem(this,'imgLatEsq','iconLatEsq')">
                                </div>
                            </div>
                        </div>
                        <textarea id="analiseIA" class="form-control mb-3" rows="3" placeholder="An√°lise autom√°tica..."></textarea>
                        <button onclick="salvarFotos()" class="btn btn-success w-100 btn-lg">Salvar Fotos</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- REFER√äNCIAS ---
    const REF_GONIO = {
        'coluna': { 'Cervical': { 'Flex√£o': 65, 'Extens√£o': 50, 'Flex√£o Lateral': 40, 'Rota√ß√£o': 55 }, 'Lombar': { 'Flex√£o': 95, 'Extens√£o': 35, 'Flex√£o Lateral': 40, 'Rota√ß√£o': 35 } },
        'superior': { 'Ombro': { 'Flex√£o': 180, 'Extens√£o': 45, 'Adu√ß√£o': 40, 'Abdu√ß√£o': 180, 'Rota√ß√£o Int/Ext': 90 }, 'Cotovelo': { 'Flex√£o': 145, 'Extens√£o': 0 }, 'Punho': { 'Flex√£o': 90, 'Extens√£o': 70, 'Desvio Ulnar': 45, 'Desvio Radial': 20 } },
        'inferior': { 'Quadril': { 'Flex√£o': 125, 'Extens√£o': 10, 'Adu√ß√£o': 15, 'Abdu√ß√£o': 45, 'Rot. Int/Ext': 45 }, 'Joelho': { 'Flex√£o': 140, 'Extens√£o': 0 }, 'Tornozelo': { 'Flex√£o Dorsal': 20, 'Flex√£o Plantar': 45, 'Invers√£o': 40, 'Evers√£o': 20 } }
    };

    const REF_FORCA = {
        'superior': ['Ombro - Flex√£o', 'Ombro - Abdu√ß√£o', 'Ombro - Rot. Externa', 'Cotovelo - Flex√£o', 'Cotovelo - Extens√£o', 'Punho - Extens√£o', 'M√£o - Preens√£o'],
        'inferior': ['Quadril - Flex√£o', 'Quadril - Extens√£o', 'Quadril - Abdu√ß√£o', 'Joelho - Extens√£o', 'Joelho - Flex√£o', 'Tornozelo - Dorsiflex√£o', 'Tornozelo - Plantiflex√£o'],
        'tronco': ['Cervical - Flex√£o', 'Cervical - Extens√£o', 'Tronco - Flex√£o', 'Tronco - Extens√£o']
    };

    // --- L√ìGICA FOR√áA MUSCULAR ---
    function atualizarMusculosForca() {
        const regiao = document.getElementById('forcaRegiao').value;
        const selMusc = document.getElementById('forcaMusculo');
        selMusc.innerHTML = '<option value="" selected>2. M√∫sculo</option>';
        selMusc.disabled = false;
        
        if (regiao && REF_FORCA[regiao]) {
            REF_FORCA[regiao].forEach(musc => {
                let opt = document.createElement('option');
                opt.value = musc;
                opt.innerText = musc;
                selMusc.appendChild(opt);
            });
        }
        document.getElementById('forcaGrau').disabled = false;
    }

    function adicionarForca() {
        const musc = document.getElementById('forcaMusculo').value;
        const grau = document.getElementById('forcaGrau').value;
        const lat = document.querySelector('input[name="forcaLat"]:checked').value;
        
        if (!musc || !grau) return alert("Selecione m√∫sculo e grau.");

        const textoItem = `${musc} (${lat}): ${grau}`;
        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center list-group-item-action";
        li.innerHTML = `<span><i class="bi bi-lightning-fill text-warning"></i> ${textoItem}</span> <button class="btn btn-sm btn-outline-danger py-0" onclick="this.parentElement.remove(); atualizarCampoForca()">X</button>`;
        
        document.getElementById('listaForca').appendChild(li);
        atualizarCampoForca();
    }

    function atualizarCampoForca() {
        const lista = document.getElementById('listaForca').getElementsByTagName('li');
        let textoFinal = "";
        for (let item of lista) {
            textoFinal += item.innerText.replace("X", "").trim() + "\n";
        }
        document.getElementById('avForca').value = textoFinal;
    }

    // --- L√ìGICA GONIOMETRIA ---
    function atualizarArticulacoes() {
        const regiao = document.getElementById('gonioRegiao').value;
        const selArt = document.getElementById('gonioArticulacao');
        selArt.innerHTML = '<option value="" selected>2. Articula√ß√£o</option>';
        selArt.disabled = false;
        if (regiao && REF_GONIO[regiao]) {
            Object.keys(REF_GONIO[regiao]).forEach(art => {
                let opt = document.createElement('option');
                opt.value = art;
                opt.innerText = art;
                selArt.appendChild(opt);
            });
        }
        document.getElementById('gonioMovimento').innerHTML = '<option>3. Movimento</option>';
        document.getElementById('gonioMovimento').disabled = true;
    }

    function atualizarMovimentos() {
        const regiao = document.getElementById('gonioRegiao').value;
        const art = document.getElementById('gonioArticulacao').value;
        const selMov = document.getElementById('gonioMovimento');
        selMov.innerHTML = '<option value="" selected>3. Movimento</option>';
        selMov.disabled = false;
        if (regiao && art && REF_GONIO[regiao][art]) {
            Object.keys(REF_GONIO[regiao][art]).forEach(mov => {
                let opt = document.createElement('option');
                opt.value = mov;
                opt.innerText = mov + " (Max: " + REF_GONIO[regiao][art][mov] + "¬∞)";
                selMov.appendChild(opt);
            });
        }
    }

    function atualizarGraus() {
        const regiao = document.getElementById('gonioRegiao').value;
        const art = document.getElementById('gonioArticulacao').value;
        const mov = document.getElementById('gonioMovimento').value;
        const selGraus = document.getElementById('gonioGraus');
        selGraus.innerHTML = '<option value="" selected>4. Selecione o Grau</option>';
        selGraus.disabled = false;
        if (regiao && art && mov) {
            const max = REF_GONIO[regiao][art][mov];
            const step = Math.ceil(max / 4);
            selGraus.add(new Option(`0¬∞ a ${step}¬∞ (Limitado)`, `0-${step}`));
            selGraus.add(new Option(`${step+1}¬∞ a ${step*2}¬∞ (Moderado)`, `${step+1}-${step*2}`));
            selGraus.add(new Option(`${step*2+1}¬∞ a ${step*3}¬∞ (Funcional)`, `${step*2+1}-${step*3}`));
            selGraus.add(new Option(`${step*3+1}¬∞ a ${max}¬∞ (Completo)`, `${step*3+1}-${max}`));
            selGraus.add(new Option(`> ${max}¬∞ (Hiperm√≥vel)`, `>${max}`));
        }
    }

    function adicionarGoniometria() {
        const art = document.getElementById('gonioArticulacao').value;
        const mov = document.getElementById('gonioMovimento').value;
        const tipo = document.querySelector('input[name="gonioTipo"]:checked').value;
        const grau = document.getElementById('gonioGraus').value;
        const dor = document.getElementById('gonioDor').checked ? " [COM DOR]" : "";
        const lat = document.querySelector('input[name="gonioLat"]:checked').value;

        if (!art || !mov || !grau) return alert("Selecione todos os campos.");

        const textoItem = `${art} (${lat}) - ${mov} (${tipo}): ${grau}¬∞ ${dor}`;
        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `${textoItem} <button class="btn btn-sm btn-outline-danger py-0" onclick="this.parentElement.remove(); atualizarCampoOculto()">X</button>`;
        document.getElementById('listaGoniometria').appendChild(li);

        atualizarCampoOculto();
    }

    function atualizarCampoOculto() {
        const lista = document.getElementById('listaGoniometria').getElementsByTagName('li');
        let textoFinal = "";
        for (let item of lista) {
            textoFinal += item.innerText.replace("X", "").trim() + "\n";
        }
        document.getElementById('avADM').value = textoFinal;
    }

    // --- FUN√á√ïES GERAIS ---
    function filtrarLista() {
        var f = document.getElementById("filtroPaciente").value.toUpperCase();
        var c = document.getElementsByClassName("item-paciente");
        for (var i = 0; i < c.length; i++) {
            c[i].style.display = c[i].innerText.toUpperCase().indexOf(f) > -1 ? "" : "none";
        }
    }

    function addComorbidade(s) {
        if (s.value) {
            var t = document.getElementById('avHPP');
            t.value += (t.value ? ", " : "") + s.value;
            s.selectedIndex = 0;
        }
    }

    function addRedFlag(f) {
        var t = document.getElementById('avHMA');
        if (t.value.indexOf(f) === -1) {
            t.value = "[üö© " + f + "] " + t.value;
        }
    }

    function toggleTabagismo() {
        var s = document.getElementById('selTabagismo').value;
        if (s.includes('Tabagista') || s.includes('Ex-tabagista')) {
            document.getElementById('divCargaTabagica').classList.remove('d-none');
        } else {
            document.getElementById('divCargaTabagica').classList.add('d-none');
        }
        gerarTextoHabitos();
    }

    function gerarTextoHabitos() {
        var a = document.getElementById('selAtividade').value;
        var e = document.getElementById('selEtilismo').value;
        var t = document.getElementById('selTabagismo').value;
        var txt = `Atividade: ${a}. Etilismo: ${e}. Tabagismo: ${t}`;
        
        if (t.includes('Tabagista') || t.includes('Ex-tabagista')) {
            var c = parseFloat(document.getElementById('numCigarros').value) || 0;
            var y = parseFloat(document.getElementById('numAnosFumo').value) || 0;
            var r = (c / 20) * y;
            document.getElementById('resCargaTabagica').innerText = r.toFixed(1) + " Ma√ßos-ano";
            txt += ` (${c} cigs/dia por ${y} anos = ${r.toFixed(1)} ma√ßos-ano)`;
        }
        document.getElementById('avHabitos').value = txt;
    }

    // --- CARREGAR E SALVAR ---
    function carregarAvaliacao(id) {
        fetch(`/api/get_avaliacao/${id}`).then(r => r.json()).then(data => {
            if(data.encontrado) {
                // Campos Simples
                ['avOcupacao','avDiagMedico','avQP','avHMA','avHPP','avHabitos','avInspecao','avPalpacao','avTestes','avCIF','avObjetivos','avConduta'].forEach(k => document.getElementById(k).value = data[k.replace('av','').toLowerCase()] || data[k] || '');
                
                // Goniometria
                const admSalva = data.adm || '';
                document.getElementById('avADM').value = admSalva;
                const ulG = document.getElementById('listaGoniometria');
                ulG.innerHTML = '';
                if(admSalva) {
                    admSalva.split('\n').forEach(l => {
                        if(l.trim()) {
                            let li = document.createElement('li');
                            li.className = "list-group-item d-flex justify-content-between align-items-center";
                            li.innerHTML = `${l} <button class="btn btn-sm btn-outline-danger py-0" onclick="this.parentElement.remove(); atualizarCampoOculto()">X</button>`;
                            ulG.appendChild(li);
                        }
                    });
                }

                // For√ßa Muscular
                const forcaSalva = data.forca_muscular || '';
                document.getElementById('avForca').value = forcaSalva;
                const ulF = document.getElementById('listaForca');
                ulF.innerHTML = '';
                if(forcaSalva) {
                    forcaSalva.split('\n').forEach(l => {
                        if(l.trim()) {
                            let li = document.createElement('li');
                            li.className = "list-group-item d-flex justify-content-between align-items-center list-group-item-action";
                            li.innerHTML = `<span><i class="bi bi-lightning-fill text-warning"></i> ${l}</span> <button class="btn btn-sm btn-outline-danger py-0" onclick="this.parentElement.remove(); atualizarCampoForca()">X</button>`;
                            ulF.appendChild(li);
                        }
                    });
                }

                // JSONs
                try {
                    let s = JSON.parse(data.sinais_vitais);
                    document.getElementById('sinPA').value = s.pa;
                    document.getElementById('sinFC').value = s.fc;
                    document.getElementById('sinSpO2').value = s.spo2;
                    document.getElementById('sinTemp').value = s.temp;
                } catch(e) { document.getElementById('sinPA').value = data.sinais_vitais || ''; }

                try {
                    let d = JSON.parse(data.avaliacao_dor);
                    document.getElementById('dorEVA').value = d.eva;
                    document.getElementById('dorLocal').value = d.local;
                    document.getElementById('dorTipo').value = d.tipo;
                    document.getElementById('dorPiora').value = d.piora;
                    document.getElementById('dorAlivio').value = d.alivia;
                } catch(e) { document.getElementById('dorLocal').value = data.avaliacao_dor || ''; }
                
                document.getElementById('dataUltimaAvaliacao').innerText = "Atualizado em: " + data.data;
            }
        });
    }

    function salvarAvaliacao() {
        const id = document.getElementById('idPacienteProntuario').value;
        const jsonSinais = JSON.stringify({
            pa: document.getElementById('sinPA').value,
            fc: document.getElementById('sinFC').value,
            spo2: document.getElementById('sinSpO2').value,
            temp: document.getElementById('sinTemp').value
        });
        const jsonDor = JSON.stringify({
            eva: document.getElementById('dorEVA').value,
            local: document.getElementById('dorLocal').value,
            tipo: document.getElementById('dorTipo').value,
            piora: document.getElementById('dorPiora').value,
            alivia: document.getElementById('dorAlivio').value
        });

        const dados = {
            paciente_id: id, sinais_vitais: jsonSinais, avaliacao_dor: jsonDor,
            ocupacao: document.getElementById('avOcupacao').value, lateralidade: document.getElementById('avLateralidade').value,
            diagnostico_medico: document.getElementById('avDiagMedico').value, queixa_principal: document.getElementById('avQP').value,
            hma: document.getElementById('avHMA').value, hpp: document.getElementById('avHPP').value, habitos: document.getElementById('avHabitos').value,
            inspecao: document.getElementById('avInspecao').value, palpacao: document.getElementById('avPalpacao').value,
            adm: document.getElementById('avADM').value, forca_muscular: document.getElementById('avForca').value,
            neuro: '', testes_especiais: document.getElementById('avTestes').value,
            diagnostico_cif: document.getElementById('avCIF').value, objetivos: document.getElementById('avObjetivos').value, conduta: document.getElementById('avConduta').value
        };

        fetch('/api/salvar_avaliacao', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dados)
        }).then(() => {
            alert("Salvo!");
            carregarAvaliacao(id);
        });
    }

    function abrirProntuario(id, nome) {
        document.getElementById('idPacienteProntuario').value = id;
        document.getElementById('tituloProntuario').innerText = nome;
        var m = new bootstrap.Modal(document.getElementById('modalProntuario'));
        m.show();
        carregarHistorico(id);
        carregarAvaliacao(id);
        carregarFotos(id);
    }

    function processarImagem(input, imgId, iconId) {
        if (input.files && input.files[0]) {
            var r = new FileReader();
            r.onload = function(e) {
                var i = new Image();
                i.src = e.target.result;
                i.onload = function() {
                    var c = document.createElement('canvas');
                    var ctx = c.getContext('2d');
                    var ratio = Math.min(600 / i.width, 1);
                    c.width = i.width * ratio;
                    c.height = i.height * ratio;
                    ctx.drawImage(i, 0, 0, c.width, c.height);
                    var d = c.toDataURL('image/jpeg', 0.7);
                    document.getElementById(imgId).src = d;
                    document.getElementById(imgId).classList.remove('d-none');
                    document.getElementById(iconId).classList.add('d-none');
                };
            };
            r.readAsDataURL(input.files[0]);
        }
    }

    function salvarFotos() {
        const id = document.getElementById('idPacienteProntuario').value;
        const d = {
            paciente_id: id,
            frontal: document.getElementById('imgFrontal').src,
            posterior: document.getElementById('imgPosterior').src,
            lat_dir: document.getElementById('imgLatDir').src,
            lat_esq: document.getElementById('imgLatEsq').src,
            analise_ia: document.getElementById('analiseIA').value
        };
        if (d.frontal.length < 100) return alert('Foto?');
        fetch('/api/salvar_fotos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(d)
        }).then(() => {
            alert('Fotos Salvas');
        });
    }

    function carregarFotos(id) {
        fetch(`/api/get_fotos/${id}`).then(r => r.json()).then(d => {
            if (d.encontrado) {
                ['Frontal', 'Posterior', 'LatDir', 'LatEsq'].forEach(t => {
                    var k = t == 'LatDir' ? 'lat_dir' : (t == 'LatEsq' ? 'lat_esq' : t.toLowerCase());
                    if (d[k] && d[k].length > 100) {
                        document.getElementById('img' + t).src = d[k];
                        document.getElementById('img' + t).classList.remove('d-none');
                        document.getElementById('icon' + t).classList.add('d-none');
                    }
                });
                document.getElementById('analiseIA').value = d.analise || '';
            }
        });
    }

    function carregarHistorico(id) {
        const l = document.getElementById('listaHistorico');
        l.innerHTML = '...';
        fetch(`/api/evolucoes/${id}`).then(r => r.json()).then(d => {
            l.innerHTML = '';
            d.forEach(i => {
                l.innerHTML += `<div class="card mb-2 p-2"><small class="fw-bold">${i.data}</small><p class="m-0">${i.texto}</p></div>`;
            });
        });
    }

    function salvarEvolucao() {
        const id = document.getElementById('idPacienteProntuario').value;
        const t = document.getElementById('textoEvolucao').value;
        if (!t) return;
        fetch('/api/nova_evolucao', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({paciente_id: id, texto: t})
        }).then(() => {
            document.getElementById('textoEvolucao').value = '';
            carregarHistorico(id);
        });
    }

    const btnVoiceEvo = document.getElementById('btnVoiceEvo');
    if (btnVoiceEvo) {
        btnVoiceEvo.addEventListener('click', () => {
            const r = new webkitSpeechRecognition();
            r.lang = 'pt-BR';
            r.start();
            r.onresult = (e) => {
                document.getElementById('textoEvolucao').value += e.results[0][0].transcript + '. ';
            };
        });
    }
</script>
{% endblock %}