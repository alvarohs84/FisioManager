{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="brand-title"><i class="bi bi-journal-medical text-primary me-2"></i> Prontu√°rio Eletr√¥nico</h2>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
            <input type="text" id="filtroPaciente" class="form-control border-start-0" placeholder="Buscar paciente..." onkeyup="filtrarLista()">
        </div>
    </div>
</div>

<div class="row" id="listaPacientesCards">
    {% for p in pacientes %}
    <div class="col-md-4 mb-3 item-paciente">
        <div class="card h-100 border-0 shadow-sm hover-card">
            <div class="card-body d-flex flex-column align-items-center text-center p-4">
                <div class="rounded-circle bg-primary bg-opacity-10 p-3 mb-3 text-primary">
                    <i class="bi bi-person-fill fs-3"></i>
                </div>
                <h5 class="card-title fw-bold text-dark mb-1 nome-paciente">{{ p[1] }}</h5>
                <p class="text-muted small mb-3">
                    <i class="bi bi-cake2"></i> {% if p[2] %} {{ p[2].strftime('%d/%m/%Y') }} {% else %} Data n/d {% endif %}
                </p>
                <button class="btn btn-primary w-100 mt-auto rounded-pill" onclick="abrirProntuario({{ p[0] }}, '{{ p[1] }}')">
                    <i class="bi bi-folder2-open"></i> Abrir Ficha
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5"><p class="text-muted">Nenhum paciente encontrado.</p></div>
    {% endfor %}
</div>

<div class="modal fade" id="modalProntuario" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-clipboard2-pulse"></i> Ficha: <span id="tituloProntuario" class="fw-bold"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body bg-light">
                <input type="hidden" id="idPacienteProntuario">

                <ul class="nav nav-tabs mb-3" id="prontuarioTabs" role="tablist">
                    <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#tab-evolucao"><i class="bi bi-list-check"></i> Evolu√ß√£o</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-avaliacao"><i class="bi bi-person-lines-fill"></i> Avalia√ß√£o</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-postural"><i class="bi bi-camera-fill"></i> Postural (IA)</button></li>
                </ul>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-evolucao">
                        <div class="row">
                            <div class="col-md-5 border-end">
                                <h6 class="text-primary fw-bold mb-3">Nova Evolu√ß√£o</h6>
                                <div class="mb-3">
                                    <div class="input-group">
                                        <textarea id="textoEvolucao" class="form-control" rows="8" placeholder="Relate o procedimento..."></textarea>
                                        <button class="btn btn-outline-secondary" type="button" id="btnVoiceEvo"><i class="bi bi-mic-fill"></i></button>
                                    </div>
                                </div>
                                <div class="d-grid"><button onclick="salvarEvolucao()" class="btn btn-success"><i class="bi bi-save"></i> Salvar</button></div>
                            </div>
                            <div class="col-md-7">
                                <h6 class="text-muted fw-bold mb-3">Hist√≥rico</h6>
                                <div id="listaHistorico" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-avaliacao">
                        <div class="accordion" id="accordionAvaliacao">
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button fw-bold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                        I. Anamnese (Hist√≥rico Cl√≠nico)
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionAvaliacao">
                                    <div class="accordion-body">
                                        
                                        <div class="alert alert-danger mb-4 shadow-sm">
                                            <h6 class="alert-heading fw-bold mb-2"><i class="bi bi-exclamation-triangle-fill"></i> Red Flags (Sinais de Alerta)</h6>
                                            <p class="small mb-2">Selecione para adicionar ao hist√≥rico (HMA):</p>
                                            <div class="row g-2">
                                                <div class="col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start" onclick="addRedFlag('Perda de peso inexplicada')">üìâ Perda de peso inexplicada</button></div>
                                                <div class="col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start" onclick="addRedFlag('Dor noturna constante')">üåô Dor noturna/repouso</button></div>
                                                <div class="col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start" onclick="addRedFlag('Hist√≥rico de C√¢ncer')">üéóÔ∏è Hist√≥rico de C√¢ncer</button></div>
                                                <div class="col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start" onclick="addRedFlag('Febre/Infec√ß√£o recente')">üå°Ô∏è Febre/Infec√ß√£o recente</button></div>
                                                <div class="col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start" onclick="addRedFlag('D√©ficit neurol√≥gico progressivo')">üß† D√©ficit neuro progressivo</button></div>
                                                <div class="col-md-4"><button class="btn btn-sm btn-outline-danger w-100 text-start" onclick="addRedFlag('Disfun√ß√£o Bexiga/Intestino')">üöΩ Disfun√ß√£o Bexiga/Intestino</button></div>
                                            </div>
                                        </div>

                                        <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3">1. Identifica√ß√£o</h6>
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small text-muted">Ocupa√ß√£o</label>
                                                <input type="text" id="avOcupacao" class="form-control" placeholder="Demandas ergon√¥micas...">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small text-muted">Lateralidade</label>
                                                <select id="avLateralidade" class="form-select">
                                                    <option>Destro</option>
                                                    <option>Canhoto</option>
                                                    <option>Ambidestro</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small text-muted">Diagn√≥stico M√©dico</label>
                                                <input type="text" id="avDiagMedico" class="form-control">
                                            </div>
                                        </div>

                                        <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3 mt-4">2. Hist√≥ria Cl√≠nica</h6>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold text-dark">Queixa Principal (QP)</label>
                                            <div class="input-group">
                                                <input type="text" id="avQP" class="form-control" placeholder="Motivo exato...">
                                                <button class="btn btn-outline-secondary" onclick="startVoice('avQP', this)"><i class="bi bi-mic-fill"></i></button>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold text-dark">HMA (Red Flags aparecer√£o aqui)</label>
                                            <div class="input-group">
                                                <textarea id="avHMA" class="form-control" rows="3" placeholder="Hist√≥rico da dor..."></textarea>
                                                <button class="btn btn-outline-secondary" onclick="startVoice('avHMA', this)"><i class="bi bi-mic-fill"></i></button>
                                            </div>
                                        </div>

                                        <div class="mb-3 p-3 bg-light rounded border">
                                            <label class="form-label fw-bold text-dark">Comorbidades (HPP)</label>
                                            <div class="row g-2 mb-2">
                                                <div class="col-md-4"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" selected disabled>üß† Neurol√≥gicas...</option><option value="AVC">AVC</option><option value="Parkinson">Parkinson</option><option value="Alzheimer">Alzheimer</option><option value="Esclerose M√∫ltipla">Esclerose M√∫ltipla</option><option value="Epilepsia">Epilepsia</option><option value="Neuropatias">Neuropatias</option><option value="Cefaleias">Cefaleias (Enxaqueca)</option></select></div>
                                                <div class="col-md-4"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" selected disabled>‚öñÔ∏è Metab√≥licas...</option><option value="Diabetes">Diabetes</option><option value="Hipertens√£o">Hipertens√£o</option><option value="Obesidade">Obesidade</option><option value="Dislipidemias">Dislipidemias</option><option value="Hipotireoidismo">Hipotireoidismo</option><option value="Osteoporose">Osteoporose</option></select></div>
                                                <div class="col-md-4"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" selected disabled>ü¶¥ Ortop√©dicas...</option><option value="Artrose">Artrose</option><option value="Fratura">Fratura</option><option value="Lombalgia">Lombalgia</option><option value="H√©rnia de Disco">H√©rnia de Disco</option><option value="Tendinopatia">Tendinopatia</option><option value="Bursite">Bursite</option></select></div>
                                            </div>
                                            <div class="row g-2 mb-2">
                                                <div class="col-md-6"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" selected disabled>‚ù§Ô∏è Cardiovasculares...</option><option value="DAC / Isqu√™mica">DAC / Isqu√™mica</option><option value="Insufici√™ncia Card√≠aca">Insufici√™ncia Card√≠aca</option><option value="Arritmias">Arritmias</option><option value="Doen√ßas Valvares">Doen√ßas Valvares</option><option value="AVC">AVC</option><option value="TVP / TEP">TVP / TEP</option></select></div>
                                                <div class="col-md-6"><select class="form-select form-select-sm" onchange="addComorbidade(this)"><option value="" selected disabled>ü´Å Respirat√≥rias...</option><option value="Asma">Asma</option><option value="DPOC">DPOC</option><option value="Fibrose Pulmonar">Fibrose Pulmonar</option><option value="Pneumonia">Pneumonia</option><option value="Apneia do Sono">Apneia do Sono</option><option value="Sequela COVID-19">Sequela COVID-19</option></select></div>
                                            </div>
                                            <div class="input-group"><textarea id="avHPP" class="form-control" rows="2" placeholder="Selecione acima ou digite..."></textarea><button class="btn btn-outline-secondary" onclick="startVoice('avHPP', this)"><i class="bi bi-mic-fill"></i></button></div>
                                        </div>

                                        <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3 mt-4">3. H√°bitos de Vida</h6>
                                        <div class="p-3 border rounded bg-light mb-3">
                                            <div class="row g-3">
                                                <div class="col-md-4"><label class="form-label small fw-bold text-primary">üèÉ Atividade F√≠sica</label><select id="selAtividade" class="form-select" onchange="gerarTextoHabitos()"><option value="Sedent√°rio">Sedent√°rio</option><option value="Leve (1-2x/sem)">Leve (1-2x/sem)</option><option value="Moderada (3-4x/sem)">Moderada (3-4x/sem)</option><option value="Intensa (5x+/sem)">Intensa (Atleta)</option></select></div>
                                                <div class="col-md-4"><label class="form-label small fw-bold text-primary">üç∫ Etilismo</label><select id="selEtilismo" class="form-select" onchange="gerarTextoHabitos()"><option value="Nega etilismo">Nega</option><option value="Etilista social">Social</option><option value="Etilista moderado">Moderado</option><option value="Etilista pesado">Abusivo/Pesado</option></select></div>
                                                <div class="col-md-4"><label class="form-label small fw-bold text-primary">üö¨ Tabagismo</label><select id="selTabagismo" class="form-select" onchange="toggleTabagismo()"><option value="Nega tabagismo">Nega</option><option value="Ex-tabagista">Ex-tabagista</option><option value="Tabagista">Tabagista Ativo</option></select></div>
                                            </div>
                                            <div id="divCargaTabagica" class="mt-3 p-2 bg-warning-subtle rounded d-none border border-warning"><label class="small fw-bold text-dark d-block mb-2">Calculadora de Carga Tab√°gica</label><div class="row g-2 align-items-center"><div class="col-md-4"><div class="input-group input-group-sm"><span class="input-group-text">Cigs/dia</span><input type="number" id="numCigarros" class="form-control" value="20" oninput="gerarTextoHabitos()"></div></div><div class="col-md-4"><div class="input-group input-group-sm"><span class="input-group-text">Anos</span><input type="number" id="numAnosFumo" class="form-control" value="10" oninput="gerarTextoHabitos()"></div></div><div class="col-md-4 text-end"><span class="badge bg-danger fs-6" id="resCargaTabagica">0 Ma√ßos-ano</span></div></div></div>
                                            <div class="mt-3"><label class="form-label small text-muted">Texto Gerado:</label><textarea id="avHabitos" class="form-control bg-white" rows="2" readonly></textarea></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">II. Exame F√≠sico (Objetivo)</button></h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionAvaliacao">
                                    <div class="accordion-body">
                                        
                                        <div class="mb-4">
                                            <label class="form-label fw-bold text-dark">Sinais Vitais</label>
                                            <div class="row g-2">
                                                <div class="col-md-2"><div class="form-floating"><input type="text" class="form-control" id="sinPA" placeholder="PA"><label>PA (mmHg)</label></div></div>
                                                <div class="col-md-2"><div class="form-floating"><input type="text" class="form-control" id="sinFC" placeholder="FC"><label>FC (bpm)</label></div></div>
                                                <div class="col-md-2"><div class="form-floating"><input type="text" class="form-control" id="sinSpO2" placeholder="SpO2"><label>SpO2 (%)</label></div></div>
                                                <div class="col-md-3"><div class="form-floating"><input type="text" class="form-control" id="sinFR" placeholder="FR"><label>FR (rpm)</label></div></div>
                                                <div class="col-md-3"><div class="form-floating"><input type="text" class="form-control" id="sinTemp" placeholder="Temp"><label>Temp (¬∞C)</label></div></div>
                                            </div>
                                        </div>

                                        <div class="mb-4 p-3 bg-light rounded border">
                                            <label class="form-label fw-bold text-dark mb-3">Avalia√ß√£o da Dor</label>
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-2">
                                                    <label class="form-label small fw-bold">EVA (0-10)</label>
                                                    <input type="number" id="dorEVA" class="form-control" min="0" max="10">
                                                </div>
                                                <div class="col-md-5">
                                                    <label class="form-label small fw-bold">Localiza√ß√£o</label>
                                                    <input type="text" id="dorLocal" class="form-control" placeholder="Ex: Lombar irradiada p/ perna...">
                                                </div>
                                                <div class="col-md-5">
                                                    <label class="form-label small fw-bold">Tipo da Dor</label>
                                                    <select id="dorTipo" class="form-select">
                                                        <option value="">Selecione...</option>
                                                        <option value="Pontada">Pontada / Agulhada</option>
                                                        <option value="Queima√ß√£o">Queima√ß√£o / Ard√™ncia</option>
                                                        <option value="Puls√°til">Puls√°til</option>
                                                        <option value="Peso/Cansa√ßo">Peso / Cansa√ßo</option>
                                                        <option value="Choque">Choque El√©trico</option>
                                                        <option value="Formigamento">Formigamento</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label small fw-bold text-danger"><i class="bi bi-graph-up-arrow"></i> Fatores de Piora</label>
                                                    <input type="text" id="dorPiora" class="form-control" placeholder="O que piora? Ex: Frio, Movimento...">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label small fw-bold text-success"><i class="bi bi-graph-down-arrow"></i> Fatores de Al√≠vio</label>
                                                    <input type="text" id="dorAlivio" class="form-control" placeholder="O que alivia? Ex: Repouso, Calor...">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row"><div class="col-md-6"><label class="form-label fw-bold">Inspe√ß√£o</label><textarea id="avInspecao" class="form-control" rows="2"></textarea></div><div class="col-md-6"><label class="form-label fw-bold">Palpa√ß√£o</label><textarea id="avPalpacao" class="form-control" rows="2"></textarea></div></div>
                                        <div class="row mt-2"><div class="col-md-6"><label class="form-label fw-bold">ADM</label><textarea id="avADM" class="form-control" rows="2"></textarea></div><div class="col-md-6"><label class="form-label fw-bold">For√ßa Muscular</label><textarea id="avForca" class="form-control" rows="2"></textarea></div></div>
                                        <div class="mt-2"><label class="form-label fw-bold">Testes Especiais / Neuro</label><textarea id="avTestes" class="form-control" rows="2"></textarea></div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">III. Diagn√≥stico e Conduta</button></h2>
                                <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionAvaliacao">
                                    <div class="accordion-body">
                                        <div class="mb-3"><label class="form-label fw-bold">Diagn√≥stico (CIF)</label><textarea id="avCIF" class="form-control" rows="2"></textarea></div>
                                        <div class="mb-3"><label class="form-label fw-bold">Objetivos</label><textarea id="avObjetivos" class="form-control" rows="2"></textarea></div>
                                        <div class="mb-3"><label class="form-label fw-bold">Conduta</label><textarea id="avConduta" class="form-control" rows="2"></textarea></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted" id="dataUltimaAvaliacao">Carregando...</small>
                            <button type="button" onclick="salvarAvaliacao()" class="btn btn-primary btn-lg"><i class="bi bi-file-earmark-medical"></i> Salvar Avalia√ß√£o Completa</button>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-postural">
                        <div class="alert alert-info py-2 small"><i class="bi bi-info-circle"></i> As fotos s√£o redimensionadas automaticamente.</div>
                        <div class="row text-center">
                            <div class="col-md-3 mb-3"><div class="card h-100"><div class="card-header fw-bold">Frontal</div><div class="card-body p-1 d-flex align-items-center justify-content-center bg-light" style="height: 200px;"><img id="imgFrontal" src="" class="img-fluid d-none" style="max-height: 100%;"><i id="iconFrontal" class="bi bi-person-standing fs-1 text-muted"></i></div><div class="card-footer p-1"><input type="file" id="fileFrontal" class="d-none" accept="image/*" onchange="processarImagem(this, 'imgFrontal', 'iconFrontal')"><button class="btn btn-sm btn-outline-primary w-100" onclick="document.getElementById('fileFrontal').click()"><i class="bi bi-camera"></i> Capturar</button></div></div></div>
                            <div class="col-md-3 mb-3"><div class="card h-100"><div class="card-header fw-bold">Posterior</div><div class="card-body p-1 d-flex align-items-center justify-content-center bg-light" style="height: 200px;"><img id="imgPosterior" src="" class="img-fluid d-none" style="max-height: 100%;"><i id="iconPosterior" class="bi bi-person-standing fs-1 text-muted"></i></div><div class="card-footer p-1"><input type="file" id="filePosterior" class="d-none" accept="image/*" onchange="processarImagem(this, 'imgPosterior', 'iconPosterior')"><button class="btn btn-sm btn-outline-primary w-100" onclick="document.getElementById('filePosterior').click()"><i class="bi bi-camera"></i> Capturar</button></div></div></div>
                            <div class="col-md-3 mb-3"><div class="card h-100"><div class="card-header fw-bold">Lat. Direita</div><div class="card-body p-1 d-flex align-items-center justify-content-center bg-light" style="height: 200px;"><img id="imgLatDir" src="" class="img-fluid d-none" style="max-height: 100%;"><i id="iconLatDir" class="bi bi-arrow-right fs-1 text-muted"></i></div><div class="card-footer p-1"><input type="file" id="fileLatDir" class="d-none" accept="image/*" onchange="processarImagem(this, 'imgLatDir', 'iconLatDir')"><button class="btn btn-sm btn-outline-primary w-100" onclick="document.getElementById('fileLatDir').click()"><i class="bi bi-camera"></i> Capturar</button></div></div></div>
                            <div class="col-md-3 mb-3"><div class="card h-100"><div class="card-header fw-bold">Lat. Esquerda</div><div class="card-body p-1 d-flex align-items-center justify-content-center bg-light" style="height: 200px;"><img id="imgLatEsq" src="" class="img-fluid d-none" style="max-height: 100%;"><i id="iconLatEsq" class="bi bi-arrow-left fs-1 text-muted"></i></div><div class="card-footer p-1"><input type="file" id="fileLatEsq" class="d-none" accept="image/*" onchange="processarImagem(this, 'imgLatEsq', 'iconLatEsq')"><button class="btn btn-sm btn-outline-primary w-100" onclick="document.getElementById('fileLatEsq').click()"><i class="bi bi-camera"></i> Capturar</button></div></div></div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-8"><label class="form-label fw-bold">An√°lise da IA</label><textarea id="analiseIA" class="form-control bg-white" rows="3" readonly placeholder="A an√°lise aparecer√° aqui ap√≥s salvar..."></textarea></div>
                            <div class="col-md-4 d-flex flex-column justify-content-end"><button onclick="salvarFotos()" class="btn btn-success w-100 btn-lg"><i class="bi bi-cloud-upload"></i> Salvar Fotos</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- FUN√á√ïES GERAIS ---
    function filtrarLista() {
        var filter = document.getElementById("filtroPaciente").value.toUpperCase();
        var cards = document.getElementsByClassName("item-paciente");
        for (var i = 0; i < cards.length; i++) {
            var nome = cards[i].querySelector(".nome-paciente").innerText;
            cards[i].style.display = nome.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }

    // --- FUN√á√ïES AUXILIARES DE CAMPO ---
    function addComorbidade(select) {
        var valor = select.value;
        var campoTexto = document.getElementById('avHPP');
        if (valor) {
            if (campoTexto.value === "") { campoTexto.value = valor; } else { campoTexto.value += ", " + valor; }
            select.selectedIndex = 0;
        }
    }

    function addRedFlag(flag) {
        var campoHMA = document.getElementById('avHMA');
        var textoFlag = " [üö© RED FLAG: " + flag + "] ";
        if(campoHMA.value.indexOf(flag) === -1) {
            campoHMA.value = textoFlag + campoHMA.value;
        }
    }

    function toggleTabagismo() {
        var status = document.getElementById('selTabagismo').value;
        var divCalc = document.getElementById('divCargaTabagica');
        if (status === 'Tabagista' || status === 'Ex-tabagista') divCalc.classList.remove('d-none');
        else divCalc.classList.add('d-none');
        gerarTextoHabitos();
    }

    function gerarTextoHabitos() {
        var ativ = document.getElementById('selAtividade').value;
        var etil = document.getElementById('selEtilismo').value;
        var tab = document.getElementById('selTabagismo').value;
        var textoFinal = `Atividade F√≠sica: ${ativ}. ${etil}. ${tab}`;
        if (tab !== 'Nega tabagismo') {
            var cigs = parseFloat(document.getElementById('numCigarros').value) || 0;
            var anos = parseFloat(document.getElementById('numAnosFumo').value) || 0;
            var carga = (cigs / 20) * anos;
            var cargaFormatada = carga.toFixed(1).replace('.0', '');
            document.getElementById('resCargaTabagica').innerText = `${cargaFormatada} Ma√ßos-ano`;
            textoFinal += ` (${cigs} cigarros/dia por ${anos} anos = Carga Tab√°gica: ${cargaFormatada} ma√ßos-ano).`;
        } else { textoFinal += "."; }
        document.getElementById('avHabitos').value = textoFinal;
    }

    function abrirProntuario(id, nome) {
        document.getElementById('idPacienteProntuario').value = id;
        document.getElementById('tituloProntuario').innerText = nome;
        
        // Limpar Campos
        document.getElementById('textoEvolucao').value = '';
        limparFotos();
        const campos = ['avOcupacao','avDiagMedico','avQP','avHMA','avHPP','avInspecao','avPalpacao','avADM','avForca','avTestes','avCIF','avObjetivos','avConduta', 'sinPA', 'sinFC', 'sinSpO2', 'sinFR', 'sinTemp', 'dorEVA', 'dorLocal', 'dorPiora', 'dorAlivio'];
        campos.forEach(c => { if(document.getElementById(c)) document.getElementById(c).value = ''; });
        document.getElementById('dorTipo').selectedIndex = 0;
        
        // Resetar Habitos
        document.getElementById('selAtividade').selectedIndex = 0;
        document.getElementById('selEtilismo').selectedIndex = 0;
        document.getElementById('selTabagismo').selectedIndex = 0;
        toggleTabagismo();
        document.getElementById('avHabitos').value = '';

        var modal = new bootstrap.Modal(document.getElementById('modalProntuario'));
        modal.show();

        carregarHistorico(id);
        carregarAvaliacao(id);
        carregarFotos(id);
    }

    // --- CARREGAR DADOS ---
    function carregarAvaliacao(id) {
        fetch(`/api/get_avaliacao/${id}`).then(r => r.json()).then(data => {
            if(data.encontrado) {
                document.getElementById('avOcupacao').value = data.ocupacao || '';
                document.getElementById('avLateralidade').value = data.lateralidade || 'Destro';
                document.getElementById('avDiagMedico').value = data.diagnostico_medico || '';
                document.getElementById('avQP').value = data.queixa_principal || '';
                document.getElementById('avHMA').value = data.hma || '';
                document.getElementById('avHPP').value = data.hpp || '';
                document.getElementById('avHabitos').value = data.habitos || '';
                
                // L√ìGICA DE CARREGAMENTO INTELIGENTE (JSON)
                try {
                    // Tenta ler Sinais Vitais como JSON
                    let sinais = JSON.parse(data.sinais_vitais);
                    document.getElementById('sinPA').value = sinais.pa || '';
                    document.getElementById('sinFC').value = sinais.fc || '';
                    document.getElementById('sinSpO2').value = sinais.spo2 || '';
                    document.getElementById('sinFR').value = sinais.fr || '';
                    document.getElementById('sinTemp').value = sinais.temp || '';
                } catch(e) {
                    // Se falhar (dado antigo), tenta jogar no primeiro campo ou ignora
                    document.getElementById('sinPA').value = data.sinais_vitais || ''; 
                }

                try {
                    // Tenta ler Dor como JSON
                    let dor = JSON.parse(data.avaliacao_dor);
                    document.getElementById('dorEVA').value = dor.eva || '';
                    document.getElementById('dorLocal').value = dor.local || '';
                    document.getElementById('dorTipo').value = dor.tipo || '';
                    document.getElementById('dorPiora').value = dor.piora || '';
                    document.getElementById('dorAlivio').value = dor.alivia || '';
                } catch(e) {
                    document.getElementById('dorLocal').value = data.avaliacao_dor || '';
                }

                document.getElementById('avInspecao').value = data.inspecao || '';
                document.getElementById('avPalpacao').value = data.palpacao || '';
                document.getElementById('avADM').value = data.adm || '';
                document.getElementById('avForca').value = data.forca_muscular || '';
                document.getElementById('avTestes').value = data.testes_especiais || '';
                document.getElementById('avCIF').value = data.diagnostico_cif || '';
                document.getElementById('avObjetivos').value = data.objetivos || '';
                document.getElementById('avConduta').value = data.conduta || '';
                document.getElementById('dataUltimaAvaliacao').innerText = "√öltima atualiza√ß√£o: " + data.data;
            } else {
                document.getElementById('dataUltimaAvaliacao').innerText = "Nenhuma avalia√ß√£o registrada.";
            }
        });
    }

    // --- SALVAR (Empacota JSON) ---
    function salvarAvaliacao() {
        const id = document.getElementById('idPacienteProntuario').value;
        
        // Empacota Sinais Vitais em JSON
        const jsonSinais = JSON.stringify({
            pa: document.getElementById('sinPA').value,
            fc: document.getElementById('sinFC').value,
            spo2: document.getElementById('sinSpO2').value,
            fr: document.getElementById('sinFR').value,
            temp: document.getElementById('sinTemp').value
        });

        // Empacota Dor em JSON
        const jsonDor = JSON.stringify({
            eva: document.getElementById('dorEVA').value,
            local: document.getElementById('dorLocal').value,
            tipo: document.getElementById('dorTipo').value,
            piora: document.getElementById('dorPiora').value,
            alivia: document.getElementById('dorAlivio').value
        });

        const dados = {
            paciente_id: id,
            ocupacao: document.getElementById('avOcupacao').value,
            lateralidade: document.getElementById('avLateralidade').value,
            diagnostico_medico: document.getElementById('avDiagMedico').value,
            queixa_principal: document.getElementById('avQP').value,
            hma: document.getElementById('avHMA').value,
            hpp: document.getElementById('avHPP').value,
            habitos: document.getElementById('avHabitos').value,
            
            // Envia os JSONs prontos
            sinais_vitais: jsonSinais,
            avaliacao_dor: jsonDor,
            
            inspecao: document.getElementById('avInspecao').value,
            palpacao: document.getElementById('avPalpacao').value,
            adm: document.getElementById('avADM').value,
            forca_muscular: document.getElementById('avForca').value,
            neuro: '',
            testes_especiais: document.getElementById('avTestes').value,
            diagnostico_cif: document.getElementById('avCIF').value,
            objetivos: document.getElementById('avObjetivos').value,
            conduta: document.getElementById('avConduta').value
        };

        fetch('/api/salvar_avaliacao', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) }).then(() => {
            alert("Avalia√ß√£o Completa Salva!");
            carregarAvaliacao(id);
        });
    }

    // --- FUN√á√ïES FOTO/VOZ/HISTORICO (Mantidas) ---
    function carregarHistorico(id) { const divLista = document.getElementById('listaHistorico'); divLista.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>'; fetch(`/api/evolucoes/${id}`).then(r => r.json()).then(data => { divLista.innerHTML = ''; if(data.length === 0) { divLista.innerHTML = '<div class="alert alert-light text-center">Hist√≥rico vazio.</div>'; return; } data.forEach(item => { divLista.innerHTML += `<div class="card mb-2 border-0 shadow-sm"><div class="card-body p-3"><small class="text-primary fw-bold"><i class="bi bi-calendar-event"></i> ${item.data}</small><p class="card-text text-secondary mt-1" style="white-space: pre-wrap;">${item.texto}</p></div></div>`; }); }); }
    function salvarEvolucao() { const id = document.getElementById('idPacienteProntuario').value; const texto = document.getElementById('textoEvolucao').value; if(!texto) return alert("Escreva algo!"); fetch('/api/nova_evolucao', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ paciente_id: id, texto: texto }) }).then(() => { document.getElementById('textoEvolucao').value = ''; carregarHistorico(id); alert("Evolu√ß√£o salva!"); }); }
    function processarImagem(input, imgId, iconId) { if (input.files && input.files[0]) { var reader = new FileReader(); reader.onload = function(e) { var imgTemp = new Image(); imgTemp.src = e.target.result; imgTemp.onload = function() { var canvas = document.createElement('canvas'); var ctx = canvas.getContext('2d'); var ratio = Math.min(600 / imgTemp.width, 1); canvas.width = imgTemp.width * ratio; canvas.height = imgTemp.height * ratio; ctx.drawImage(imgTemp, 0, 0, canvas.width, canvas.height); var dataUrl = canvas.toDataURL('image/jpeg', 0.7); document.getElementById(imgId).src = dataUrl; document.getElementById(imgId).classList.remove('d-none'); document.getElementById(iconId).classList.add('d-none'); } }; reader.readAsDataURL(input.files[0]); } }
    function limparFotos() { ['Frontal','Posterior','LatDir','LatEsq'].forEach(tipo => { document.getElementById('img'+tipo).src=''; document.getElementById('img'+tipo).classList.add('d-none'); document.getElementById('icon'+tipo).classList.remove('d-none'); document.getElementById('file'+tipo).value=''; }); document.getElementById('analiseIA').value=''; }
    function salvarFotos() { const id = document.getElementById('idPacienteProntuario').value; const dados = { paciente_id: id, frontal: document.getElementById('imgFrontal').src, posterior: document.getElementById('imgPosterior').src, lat_dir: document.getElementById('imgLatDir').src, lat_esq: document.getElementById('imgLatEsq').src, analise_ia: "An√°lise IA: Desvios detectados. Sugere-se avalia√ß√£o detalhada." }; if(dados.frontal.length < 100 && dados.posterior.length < 100) return alert("Adicione uma foto."); fetch('/api/salvar_fotos', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) }).then(() => { alert("Fotos salvas!"); carregarFotos(id); }); }
    function carregarFotos(id) { fetch(`/api/get_fotos/${id}`).then(r => r.json()).then(data => { if(data.encontrado) { ['Frontal','Posterior','LatDir','LatEsq'].forEach(tipo => { let key = tipo === 'LatDir' ? 'lat_dir' : (tipo === 'LatEsq' ? 'lat_esq' : tipo.toLowerCase()); if(data[key] && data[key].length > 100) { document.getElementById('img'+tipo).src = data[key]; document.getElementById('img'+tipo).classList.remove('d-none'); document.getElementById('icon'+tipo).classList.add('d-none'); } }); document.getElementById('analiseIA').value = data.analise || ''; } }); }
    function startVoice(inputId, btn) { const input = document.getElementById(inputId); if ('webkitSpeechRecognition' in window) { const recognition = new webkitSpeechRecognition(); recognition.lang = 'pt-BR'; recognition.continuous = false; btn.classList.add('btn-danger'); recognition.start(); recognition.onresult = (e) => { let txt = e.results[0][0].transcript; input.value += (input.tagName === 'TEXTAREA' ? txt + ". " : txt); btn.classList.remove('btn-danger'); }; } else { alert("Sem suporte a voz."); } }
    const btnVoiceEvo = document.getElementById('btnVoiceEvo'); if(btnVoiceEvo) btnVoiceEvo.addEventListener('click', () => startVoice('textoEvolucao', btnVoiceEvo));
</script>
{% endblock %}