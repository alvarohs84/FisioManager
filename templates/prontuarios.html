{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="brand-title"><i class="bi bi-journal-medical text-primary me-2"></i> Prontuário Eletrônico</h2>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
            <input type="text" id="filtroPaciente" class="form-control border-start-0" placeholder="Digite o nome do paciente para buscar..." onkeyup="filtrarLista()">
        </div>
    </div>
</div>

<div class="row" id="listaPacientesCards">
    {% for p in pacientes %}
    <div class="col-md-4 mb-3 item-paciente">
        <div class="card h-100 border-0 shadow-sm hover-card">
            <div class="card-body d-flex flex-column align-items-center text-center p-4">
                <div class="rounded-circle bg-primary bg-opacity-10 p-3 mb-3 text-primary">
                    <i class="bi bi-person-fill fs-3"></i>
                </div>
                <h5 class="card-title fw-bold text-dark mb-1 nome-paciente">{{ p[1] }}</h5>
                <p class="text-muted small mb-3">
                    <i class="bi bi-cake2"></i> 
                    {% if p[2] %} {{ p[2].strftime('%d/%m/%Y') }} {% else %} Data n/d {% endif %}
                </p>
                <button class="btn btn-primary w-100 mt-auto rounded-pill" onclick="abrirProntuario({{ p[0] }}, '{{ p[1] }}')">
                    <i class="bi bi-folder2-open"></i> Abrir Ficha
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5">
        <p class="text-muted">Nenhum paciente cadastrado para exibir.</p>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="modalProntuario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-clipboard2-pulse"></i> Prontuário: <span id="tituloProntuario" class="fw-bold"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="row">
                    <div class="col-md-5 border-end">
                        <h6 class="text-primary fw-bold mb-3">Nova Evolução</h6>
                        <input type="hidden" id="idPacienteProntuario">
                        
                        <div class="mb-3">
                            <label class="form-label small text-muted">Descrição do Atendimento</label>
                            <div class="input-group">
                                <textarea id="textoEvolucao" class="form-control" rows="8" placeholder="Relate o procedimento..."></textarea>
                                <button class="btn btn-outline-secondary" type="button" id="btnVoiceEvo">
                                    <i class="bi bi-mic-fill"></i>
                                </button>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button onclick="salvarEvolucao()" class="btn btn-success">
                                <i class="bi bi-save"></i> Salvar Evolução
                            </button>
                        </div>
                    </div>

                    <div class="col-md-7">
                        <h6 class="text-muted fw-bold mb-3">Histórico Clínico</h6>
                        <div id="listaHistorico" style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                            <div class="text-center text-muted mt-5">
                                <p>Selecione um paciente...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- FILTRO DE BUSCA ---
    function filtrarLista() {
        var input = document.getElementById("filtroPaciente");
        var filter = input.value.toUpperCase();
        var cards = document.getElementsByClassName("item-paciente");

        for (var i = 0; i < cards.length; i++) {
            var nome = cards[i].querySelector(".nome-paciente").innerText;
            if (nome.toUpperCase().indexOf(filter) > -1) {
                cards[i].style.display = "";
            } else {
                cards[i].style.display = "none";
            }
        }
    }

    // --- LÓGICA DO PRONTUÁRIO ---
    function abrirProntuario(id, nome) {
        document.getElementById('idPacienteProntuario').value = id;
        document.getElementById('tituloProntuario').innerText = nome;
        document.getElementById('textoEvolucao').value = '';
        
        var modal = new bootstrap.Modal(document.getElementById('modalProntuario'));
        modal.show();
        carregarHistorico(id);
    }

    function carregarHistorico(id) {
        const divLista = document.getElementById('listaHistorico');
        divLista.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
        
        fetch(`/api/evolucoes/${id}`)
            .then(response => response.json())
            .then(data => {
                divLista.innerHTML = '';
                if(data.length === 0) {
                    divLista.innerHTML = '<div class="alert alert-light text-center">Nenhum registro encontrado.</div>';
                    return;
                }
                data.forEach(item => {
                    const card = `
                        <div class="card mb-2 border-0 shadow-sm">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-primary fw-bold"><i class="bi bi-calendar-event"></i> ${item.data}</small>
                                </div>
                                <p class="card-text text-secondary" style="white-space: pre-wrap;">${item.texto}</p>
                            </div>
                        </div>
                    `;
                    divLista.innerHTML += card;
                });
            });
    }

    function salvarEvolucao() {
        const id = document.getElementById('idPacienteProntuario').value;
        const texto = document.getElementById('textoEvolucao').value;
        if(!texto) return alert("Escreva algo!");
        
        fetch('/api/nova_evolucao', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ paciente_id: id, texto: texto })
        }).then(() => {
            document.getElementById('textoEvolucao').value = '';
            carregarHistorico(id);
        });
    }

    // Voz
    const btnVoice = document.getElementById('btnVoiceEvo');
    const inputEvo = document.getElementById('textoEvolucao');
    if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'pt-BR';
        recognition.continuous = false;
        btnVoice.addEventListener('click', () => { recognition.start(); btnVoice.classList.add('btn-danger'); });
        recognition.onresult = (e) => { 
            inputEvo.value += e.results[0][0].transcript + ". "; 
            btnVoice.classList.remove('btn-danger'); 
        };
    } else { btnVoice.style.display = 'none'; }
</script>

<style>
    .hover-card:hover { transform: translateY(-3px); transition: 0.3s; }
</style>
{% endblock %}