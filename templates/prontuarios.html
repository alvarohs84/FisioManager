{% extends "layout.html" %}

{% block content %}
<style>
    /* CSS ESPEC√çFICO PARA MOBILE - SENSA√á√ÉO DE APP */
    .btn-app { padding: 12px; font-size: 1.1rem; border-radius: 12px; }
    .form-floating > label { padding-top: 0.6rem; }
    .form-control, .form-select { height: 55px; font-size: 16px; /* Evita zoom no iPhone */ }
    .card-option { transition: all 0.2s; border: 2px solid transparent; cursor: pointer; }
    .card-option.active { border-color: var(--bs-primary); background-color: var(--bs-primary-bg-subtle); }
    .sticky-bottom-action { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; background: white; border-top: 1px solid #ddd; z-index: 1050; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    /* Ajuste para o conte√∫do n√£o ficar escondido atr√°s do bot√£o fixo */
    .modal-body { padding-bottom: 100px !important; } 
</style>

<div class="d-flex justify-content-between align-items-center mb-3 px-2">
    <h2 class="brand-title m-0 fs-4 fw-bold"><i class="bi bi-journal-medical text-primary"></i> Prontu√°rio</h2>
</div>

<div class="px-2 mb-3">
    <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
        <span class="input-group-text bg-white border-0 ps-4"><i class="bi bi-search text-muted"></i></span>
        <input type="text" id="filtroPaciente" class="form-control border-0" placeholder="Buscar..." onkeyup="filtrarLista()">
    </div>
</div>

<div class="row g-3 px-2 pb-5" id="listaPacientesCards">
    {% for p in pacientes %}
    <div class="col-12 col-md-6 item-paciente">
        <div class="card border-0 shadow-sm rounded-4" onclick="abrirProntuario({{ p[0] }}, '{{ p[1] }}')">
            <div class="card-body d-flex align-items-center p-3">
                <div class="rounded-circle bg-primary text-white p-3 me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; font-size: 1.2rem;">
                    {{ p[1][0] }}
                </div>
                <div>
                    <h6 class="fw-bold text-dark mb-0 nome-paciente">{{ p[1] }}</h6>
                    <small class="text-muted"><i class="bi bi-calendar"></i> {% if p[2] %} {{ p[2].strftime('%d/%m/%Y') }} {% else %} --/-- {% endif %}</small>
                </div>
                <div class="ms-auto bg-light rounded-circle p-2 text-primary">
                    <i class="bi bi-chevron-right"></i>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5 text-muted">Nenhum paciente.</div>
    {% endfor %}
</div>

<div class="modal fade" id="modalProntuario" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-light">
            
            <div class="modal-header bg-white border-bottom py-2 shadow-sm sticky-top">
                <button type="button" class="btn btn-light rounded-circle me-2" data-bs-dismiss="modal"><i class="bi bi-arrow-left fs-4"></i></button>
                <h5 class="modal-title fs-6 fw-bold text-truncate flex-grow-1" id="tituloProntuario">Paciente</h5>
                <div class="dropdown">
                    <button class="btn btn-light rounded-circle" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="limparFotos()">Limpar Fotos</a></li>
                    </ul>
                </div>
            </div>

            <div class="modal-body p-0">
                <input type="hidden" id="idPacienteProntuario">

                <div class="bg-white px-3 py-2">
                    <ul class="nav nav-pills nav-fill gap-2 p-1 bg-light rounded-3" id="prontuarioTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active rounded-3 fw-bold small py-2 shadow-sm" data-bs-toggle="tab" data-bs-target="#tab-evolucao">Evolu√ß√£o</button></li>
                        <li class="nav-item"><button class="nav-link rounded-3 fw-bold small py-2" data-bs-toggle="tab" data-bs-target="#tab-avaliacao">Avalia√ß√£o</button></li>
                        <li class="nav-item"><button class="nav-link rounded-3 fw-bold small py-2" data-bs-toggle="tab" data-bs-target="#tab-postural">Fotos</button></li>
                    </ul>
                </div>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active p-3" id="tab-evolucao">
                        <div class="card border-0 shadow-sm rounded-4 mb-3">
                            <div class="card-body">
                                <label class="fw-bold text-primary mb-2">Nova Evolu√ß√£o</label>
                                <textarea id="textoEvolucao" class="form-control bg-light border-0 rounded-3 mb-3" rows="6" placeholder="Toque para escrever..."></textarea>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-light btn-lg flex-grow-0" id="btnVoiceEvo"><i class="bi bi-mic-fill text-danger"></i></button>
                                    <button onclick="salvarEvolucao()" class="btn btn-primary btn-lg flex-grow-1 fw-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                        <h6 class="text-muted small fw-bold ms-2">HIST√ìRICO RECENTE</h6>
                        <div id="listaHistorico" class="d-flex flex-column gap-2"></div>
                    </div>

                    <div class="tab-pane fade p-3" id="tab-avaliacao">
                        
                        <div class="accordion accordion-flush rounded-4 shadow-sm bg-white overflow-hidden" id="accAvaliacao">
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button fw-bold py-3" type="button" data-bs-toggle="collapse" data-bs-target="#colAnamnese">1. Anamnese & HDA</button></h2>
                                <div id="colAnamnese" class="accordion-collapse collapse show" data-bs-parent="#accAvaliacao">
                                    <div class="accordion-body bg-light">
                                        <div class="d-flex flex-wrap gap-2 mb-3">
                                            <button class="badge rounded-pill bg-danger border-0 py-2 px-3 text-white" onclick="addRedFlag('Perda Peso')">üìâ Perda Peso</button>
                                            <button class="badge rounded-pill bg-danger border-0 py-2 px-3 text-white" onclick="addRedFlag('Dor Noturna')">üåô Dor Noturna</button>
                                            <button class="badge rounded-pill bg-danger border-0 py-2 px-3 text-white" onclick="addRedFlag('C√¢ncer')">üéóÔ∏è C√¢ncer</button>
                                            <button class="badge rounded-pill bg-danger border-0 py-2 px-3 text-white" onclick="addRedFlag('Febre')">üå°Ô∏è Febre</button>
                                            <button class="badge rounded-pill bg-danger border-0 py-2 px-3 text-white" onclick="addRedFlag('Neuro')">üß† Neuro</button>
                                        </div>

                                        <div class="form-floating mb-2"><input type="text" id="avQP" class="form-control rounded-3"><label>Queixa Principal</label></div>
                                        <div class="form-floating mb-3"><textarea id="avHMA" class="form-control rounded-3" style="height: 100px"></textarea><label>Hist√≥ria (HDA)</label></div>

                                        <div class="bg-white p-3 rounded-3 mb-3 border">
                                            <label class="small fw-bold text-muted mb-2">SELE√á√ÉO R√ÅPIDA (HPP)</label>
                                            <div class="d-grid gap-2">
                                                <select class="form-select form-select-lg fw-bold text-primary" onchange="addComorbidade(this)"><option value="" disabled selected>+ Adicionar Doen√ßa...</option><option value="Hipertens√£o">Hipertens√£o</option><option value="Diabetes">Diabetes</option><option value="Hernia de Disco">H√©rnia de Disco</option><option value="Artrose">Artrose</option><option value="Ansiedade">Ansiedade</option></select>
                                            </div>
                                            <textarea id="avHPP" class="form-control mt-2 border-0 bg-light" placeholder="Comorbidades selecionadas..."></textarea>
                                        </div>
                                        
                                        <div class="row g-2">
                                            <div class="col-6"><input type="text" id="avOcupacao" class="form-control" placeholder="Ocupa√ß√£o"></div>
                                            <div class="col-6"><input type="text" id="avDiagMedico" class="form-control" placeholder="Diag. M√©dico"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold py-3" type="button" data-bs-toggle="collapse" data-bs-target="#colFisico">2. Exame F√≠sico</button></h2>
                                <div id="colFisico" class="accordion-collapse collapse" data-bs-parent="#accAvaliacao">
                                    <div class="accordion-body bg-light">
                                        
                                        <div class="card border-0 shadow-sm mb-3">
                                            <div class="card-body p-3">
                                                <label class="fw-bold text-danger mb-2">Avalia√ß√£o da Dor</label>
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-3">
                                                        <div class="form-floating"><input type="number" inputmode="numeric" id="dorEVA" class="form-control fw-bold text-center fs-4 text-danger"><label>EVA</label></div>
                                                    </div>
                                                    <div class="col-9">
                                                        <input type="text" id="dorLocal" class="form-control mb-2" placeholder="Local da dor">
                                                        <select id="dorTipo" class="form-select"><option value="">Tipo...</option><option>Pontada</option><option>Queima√ß√£o</option><option>Puls√°til</option></select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row g-2 mb-3">
                                            <div class="col-3"><input type="tel" id="sinPA" class="form-control text-center" placeholder="PA"></div>
                                            <div class="col-3"><input type="tel" id="sinFC" class="form-control text-center" placeholder="FC"></div>
                                            <div class="col-3"><input type="tel" id="sinSpO2" class="form-control text-center" placeholder="%"></div>
                                            <div class="col-3"><input type="tel" id="sinTemp" class="form-control text-center" placeholder="¬∞C"></div>
                                        </div>

                                        <div class="card border-primary mb-3">
                                            <div class="card-header bg-primary text-white fw-bold">Goniometria</div>
                                            <div class="card-body p-2">
                                                <select id="gonioRegiao" class="form-select form-select-lg mb-2 fw-bold" onchange="atualizarArticulacoes()"><option selected disabled>1. Regi√£o</option><option value="superior">Superior</option><option value="inferior">Inferior</option><option value="coluna">Coluna</option></select>
                                                <div class="row g-2 mb-2">
                                                    <div class="col-6"><select id="gonioArticulacao" class="form-select" disabled onchange="atualizarMovimentos()"><option>2. Artic.</option></select></div>
                                                    <div class="col-6"><select id="gonioMovimento" class="form-select" disabled onchange="atualizarGraus()"><option>3. Mov.</option></select></div>
                                                </div>
                                                <div class="btn-group w-100 mb-2">
                                                    <input type="radio" class="btn-check" name="gonioLat" id="gLatD" value="D" checked><label class="btn btn-outline-primary py-2" for="gLatD">Dir</label>
                                                    <input type="radio" class="btn-check" name="gonioLat" id="gLatE" value="E"><label class="btn btn-outline-primary py-2" for="gLatE">Esq</label>
                                                </div>
                                                <select id="gonioGraus" class="form-select form-select-lg mb-2 fw-bold text-primary" disabled><option>4. Grau</option></select>
                                                <button class="btn btn-primary w-100 py-2" onclick="adicionarGoniometria()">+ Adicionar</button>
                                                <ul id="listaGoniometria" class="list-group mt-2"></ul>
                                                <textarea id="avADM" class="d-none"></textarea>
                                            </div>
                                        </div>

                                        <div class="card border-success mb-3">
                                            <div class="card-header bg-success text-white fw-bold">For√ßa Muscular</div>
                                            <div class="card-body p-2">
                                                <select id="forcaRegiao" class="form-select form-select-lg mb-2 fw-bold" onchange="atualizarMusculosForca()"><option selected disabled>1. Regi√£o</option><option value="superior">Superior</option><option value="inferior">Inferior</option></select>
                                                <select id="forcaMusculo" class="form-select mb-2" disabled><option>2. M√∫sculo</option></select>
                                                <div class="btn-group w-100 mb-2">
                                                    <input type="radio" class="btn-check" name="forcaLat" id="fLatD" value="D" checked><label class="btn btn-outline-success py-2" for="fLatD">Dir</label>
                                                    <input type="radio" class="btn-check" name="forcaLat" id="fLatE" value="E"><label class="btn btn-outline-success py-2" for="fLatE">Esq</label>
                                                </div>
                                                <select id="forcaGrau" class="form-select form-select-lg mb-2 fw-bold text-success" disabled><option>3. Grau (0-5)</option><option value="5">Grau 5 (Normal)</option><option value="4">Grau 4 (Bom)</option><option value="3">Grau 3 (Regular)</option></select>
                                                <button class="btn btn-success w-100 py-2" onclick="adicionarForca()">+ Adicionar</button>
                                                <ul id="listaForca" class="list-group mt-2"></ul>
                                                <textarea id="avForca" class="d-none"></textarea>
                                            </div>
                                        </div>

                                        <div class="form-floating mb-2"><textarea id="avInspecao" class="form-control" style="height:80px"></textarea><label>Inspe√ß√£o</label></div>
                                        <div class="form-floating"><textarea id="avPalpacao" class="form-control" style="height:80px"></textarea><label>Palpa√ß√£o</label></div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold py-3" type="button" data-bs-toggle="collapse" data-bs-target="#colNeuro">3. Testes & Neuro</button></h2>
                                <div id="colNeuro" class="accordion-collapse collapse" data-bs-parent="#accAvaliacao">
                                    <div class="accordion-body bg-light">
                                        <select id="testeRegiao" class="form-select form-select-lg mb-2" onchange="atualizarListaTestes()"><option selected disabled>1. Regi√£o/Neuro</option><option value="Lombar">Lombar</option><option value="Cervical">Cervical</option><option value="Ombro">Ombro</option><option value="Joelho">Joelho</option><option value="Neuro">Neurol√≥gico</option></select>
                                        <select id="testeNome" class="form-select mb-2" disabled><option>2. Teste</option></select>
                                        <div class="row g-2 mb-2">
                                            <div class="col-6">
                                                <div class="btn-group w-100"><input type="radio" class="btn-check" name="testeLat" id="tD" value="D" checked><label class="btn btn-outline-secondary" for="tD">Dir</label><input type="radio" class="btn-check" name="testeLat" id="tE" value="E"><label class="btn btn-outline-secondary" for="tE">Esq</label></div>
                                            </div>
                                            <div class="col-6"><select id="testeRes" class="form-select fw-bold"><option value="NEGATIVO" class="text-success">Negativo</option><option value="POSITIVO" class="text-danger">POSITIVO</option></select></div>
                                        </div>
                                        <button class="btn btn-dark w-100 py-2" onclick="adicionarTeste()">+ Adicionar Teste</button>
                                        <ul id="listaTestes" class="list-group mt-2"></ul>
                                        <textarea id="avTestes" class="d-none"></textarea>
                                        
                                        <input type="hidden" id="neuroCat"><input type="hidden" id="neuroTeste"><input type="hidden" id="neuroRes"><input type="hidden" id="avNeuro"><input type="radio" name="neuroLat" value="D" checked hidden>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed fw-bold py-3" type="button" data-bs-toggle="collapse" data-bs-target="#colConduta">4. Diagn√≥stico & Conduta</button></h2>
                                <div id="colConduta" class="accordion-collapse collapse" data-bs-parent="#accAvaliacao">
                                    <div class="accordion-body bg-light">
                                        <div class="form-floating mb-2"><textarea id="avCIF" class="form-control" style="height:100px"></textarea><label>Diagn√≥stico CIF</label></div>
                                        <div class="form-floating mb-2"><textarea id="avObjetivos" class="form-control" style="height:100px"></textarea><label>Objetivos</label></div>
                                        <div class="form-floating"><textarea id="avConduta" class="form-control" style="height:120px"></textarea><label>Conduta</label></div>
                                        <input type="hidden" id="selAtividade"><input type="hidden" id="selEtilismo"><input type="hidden" id="selTabagismo"><input type="hidden" id="numCigarros"><input type="hidden" id="numAnosFumo"><input type="hidden" id="avHabitos">
                                    </div>
                                </div>
                            </div>

                        </div>
                        
                        <br><br><br> </div>

                    <div class="tab-pane fade p-3" id="tab-postural">
                        <div class="row g-2 mb-3">
                            <div class="col-6"><button class="btn btn-outline-dark w-100 py-3 rounded-3" onclick="document.getElementById('fileFrontal').click()"><i class="bi bi-person fs-1 d-block"></i> Frontal</button><input type="file" id="fileFrontal" accept="image/*" capture="environment" hidden onchange="processarImagem(this,'imgFrontal','iconFrontal')"><img id="imgFrontal" class="d-none w-100 rounded mt-2"></div>
                            <div class="col-6"><button class="btn btn-outline-dark w-100 py-3 rounded-3" onclick="document.getElementById('filePosterior').click()"><i class="bi bi-person-fill fs-1 d-block"></i> Posterior</button><input type="file" id="filePosterior" accept="image/*" capture="environment" hidden onchange="processarImagem(this,'imgPosterior','iconPosterior')"><img id="imgPosterior" class="d-none w-100 rounded mt-2"></div>
                            <div class="col-6"><button class="btn btn-outline-dark w-100 py-3 rounded-3" onclick="document.getElementById('fileLatDir').click()"><i class="bi bi-arrow-right fs-1 d-block"></i> Lat. Dir</button><input type="file" id="fileLatDir" accept="image/*" capture="environment" hidden onchange="processarImagem(this,'imgLatDir','iconLatDir')"><img id="imgLatDir" class="d-none w-100 rounded mt-2"></div>
                            <div class="col-6"><button class="btn btn-outline-dark w-100 py-3 rounded-3" onclick="document.getElementById('fileLatEsq').click()"><i class="bi bi-arrow-left fs-1 d-block"></i> Lat. Esq</button><input type="file" id="fileLatEsq" accept="image/*" capture="environment" hidden onchange="processarImagem(this,'imgLatEsq','iconLatEsq')"><img id="imgLatEsq" class="d-none w-100 rounded mt-2"></div>
                        </div>
                        <div class="form-floating mb-5">
                            <textarea id="analiseIA" class="form-control" style="height: 100px" placeholder="IA"></textarea>
                            <label>An√°lise IA</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sticky-bottom-action d-flex justify-content-between align-items-center">
                <small class="text-muted" id="dataUltimaAvaliacao">...</small>
                <button onclick="salvarAvaliacao()" class="btn btn-primary rounded-pill px-4 fw-bold shadow"><i class="bi bi-save"></i> SALVAR</button>
            </div>

        </div>
    </div>
</div>

<script>
    // --- DADOS ---
    const REF_GONIO = {'coluna':{'Cervical':{'Flex√£o':65,'Extens√£o':50},'Lombar':{'Flex√£o':95,'Extens√£o':35}},'superior':{'Ombro':{'Flex√£o':180,'Abdu√ß√£o':180},'Cotovelo':{'Flex√£o':145}},'inferior':{'Quadril':{'Flex√£o':125},'Joelho':{'Flex√£o':140}}};
    const REF_FORCA = {'superior':['Ombro-Flex','Cotovelo-Flex'],'inferior':['Quadril-Flex','Joelho-Ext']};
    const REF_TESTES = {'Lombar':['Lasegue','Slump'],'Ombro':['Neer','Hawkins'],'Joelho':['Lachman','Gaveta'],'Neuro':['Reflexo Patelar','Babinski']};

    // --- FUN√á√ïES SIMPLIFICADAS ---
    function abrirProntuario(id, n) { document.getElementById('idPacienteProntuario').value=id; document.getElementById('tituloProntuario').innerText=n; new bootstrap.Modal(document.getElementById('modalProntuario')).show(); carregarAvaliacao(id); carregarHistorico(id); }
    function salvarEvolucao() { fetch('/api/nova_evolucao',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paciente_id:document.getElementById('idPacienteProntuario').value, texto:document.getElementById('textoEvolucao').value})}).then(()=>{ document.getElementById('textoEvolucao').value=''; carregarHistorico(document.getElementById('idPacienteProntuario').value); }); }
    function carregarHistorico(id) { fetch(`/api/evolucoes/${id}`).then(r=>r.json()).then(d=>{ document.getElementById('listaHistorico').innerHTML=d.map(i=>`<div class="card p-2 border-0 bg-white shadow-sm"><small class="fw-bold text-primary">${i.data}</small><div>${i.texto}</div></div>`).join(''); }); }
    
    // ATUALIZA√á√ÉO DOS MENUS
    function atualizarArticulacoes(){ const r=document.getElementById('gonioRegiao').value,s=document.getElementById('gonioArticulacao'); s.innerHTML='<option>2. Artic.</option>';s.disabled=false; if(REF_GONIO[r]) Object.keys(REF_GONIO[r]).forEach(k=>s.add(new Option(k,k))); document.getElementById('gonioMovimento').disabled=true;}
    function atualizarMovimentos(){ const r=document.getElementById('gonioRegiao').value,a=document.getElementById('gonioArticulacao').value,s=document.getElementById('gonioMovimento'); s.innerHTML='<option>3. Mov.</option>';s.disabled=false; if(REF_GONIO[r][a]) Object.keys(REF_GONIO[r][a]).forEach(k=>s.add(new Option(k,k)));}
    function atualizarGraus(){ const r=document.getElementById('gonioRegiao').value,a=document.getElementById('gonioArticulacao').value,m=document.getElementById('gonioMovimento').value,s=document.getElementById('gonioGraus'); s.innerHTML='<option>4. Grau</option>';s.disabled=false; const max=REF_GONIO[r][a][m]; s.add(new Option(`Normal (${max}¬∞)`,`${max}`)); s.add(new Option(`Limitado (${Math.round(max/2)}¬∞)`,`${Math.round(max/2)}`)); }
    function adicionarGoniometria(){ const l=document.getElementById('listaGoniometria'); l.innerHTML+=`<li class="list-group-item d-flex justify-content-between">${document.getElementById('gonioArticulacao').value} ${document.getElementById('gonioMovimento').value}: ${document.getElementById('gonioGraus').value} <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove();updt('avADM','listaGoniometria')">X</button></li>`; updt('avADM','listaGoniometria');}
    
    function atualizarMusculosForca(){ const r=document.getElementById('forcaRegiao').value,s=document.getElementById('forcaMusculo'); s.innerHTML='<option>2. M√∫sculo</option>';s.disabled=false; if(REF_FORCA[r]) REF_FORCA[r].forEach(k=>s.add(new Option(k,k))); document.getElementById('forcaGrau').disabled=false;}
    function adicionarForca(){ document.getElementById('listaForca').innerHTML+=`<li class="list-group-item d-flex justify-content-between">${document.getElementById('forcaMusculo').value}: Grau ${document.getElementById('forcaGrau').value} <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove();updt('avForca','listaForca')">X</button></li>`; updt('avForca','listaForca');}

    function atualizarListaTestes(){ const r=document.getElementById('testeRegiao').value,s=document.getElementById('testeNome'); s.innerHTML='<option>2. Teste</option>';s.disabled=false; if(REF_TESTES[r]) REF_TESTES[r].forEach(k=>s.add(new Option(k,k))); }
    function adicionarTeste(){ const res=document.getElementById('testeRes').value; const cor=res=='POSITIVO'?'text-danger':'text-success'; document.getElementById('listaTestes').innerHTML+=`<li class="list-group-item d-flex justify-content-between">${document.getElementById('testeNome').value}: <span class="${cor} fw-bold">${res}</span> <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.remove();updt('avTestes','listaTestes')">X</button></li>`; updt('avTestes','listaTestes');}

    function updt(idInput, idLista) { let t=""; for(let i of document.getElementById(idLista).children) t+=i.innerText.replace("X","").trim()+"\n"; document.getElementById(idInput).value=t; }
    function addRedFlag(t) { document.getElementById('avHMA').value = `[üö© ${t}] ` + document.getElementById('avHMA').value; }
    function addComorbidade(s) { document.getElementById('avHPP').value += (document.getElementById('avHPP').value?", ":"") + s.value; s.selectedIndex=0; }
    
    function salvarAvaliacao() {
        const d = {
            paciente_id: document.getElementById('idPacienteProntuario').value,
            ocupacao: document.getElementById('avOcupacao').value, lateralidade: document.getElementById('avLateralidade').value, diagnostico_medico: document.getElementById('avDiagMedico').value,
            queixa_principal: document.getElementById('avQP').value, hma: document.getElementById('avHMA').value, hpp: document.getElementById('avHPP').value,
            inspecao: document.getElementById('avInspecao').value, palpacao: document.getElementById('avPalpacao').value,
            adm: document.getElementById('avADM').value, forca_muscular: document.getElementById('avForca').value, testes_especiais: document.getElementById('avTestes').value,
            diagnostico_cif: document.getElementById('avCIF').value, objetivos: document.getElementById('avObjetivos').value, conduta: document.getElementById('avConduta').value,
            sinais_vitais: JSON.stringify({pa:document.getElementById('sinPA').value, fc:document.getElementById('sinFC').value, spo2:document.getElementById('sinSpO2').value, temp:document.getElementById('sinTemp').value}),
            avaliacao_dor: JSON.stringify({eva:document.getElementById('dorEVA').value, local:document.getElementById('dorLocal').value, tipo:document.getElementById('dorTipo').value, piora:document.getElementById('dorPiora').value, alivia:document.getElementById('dorAlivio').value})
        };
        fetch('/api/salvar_avaliacao', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}).then(()=>{ alert("Salvo!"); });
    }

    function carregarAvaliacao(id) {
        fetch(`/api/get_avaliacao/${id}`).then(r=>r.json()).then(d=>{
            if(d.encontrado) {
                ['avOcupacao','avDiagMedico','avQP','avHMA','avHPP','avInspecao','avPalpacao','avCIF','avObjetivos','avConduta'].forEach(k=>document.getElementById(k).value=d[k.replace('av','').toLowerCase()]||d[k]||'');
                document.getElementById('avADM').value=d.adm||''; document.getElementById('avForca').value=d.forca_muscular||''; document.getElementById('avTestes').value=d.testes_especiais||'';
                // Recria listas visuais (simplificado)
                if(d.adm) { document.getElementById('listaGoniometria').innerHTML = d.adm.split('\n').filter(x=>x).map(x=>`<li class="list-group-item d-flex justify-content-between">${x} <button onclick="this.parentElement.remove();updt('avADM','listaGoniometria')" class="btn btn-sm btn-outline-danger">X</button></li>`).join(''); }
                if(d.forca_muscular) { document.getElementById('listaForca').innerHTML = d.forca_muscular.split('\n').filter(x=>x).map(x=>`<li class="list-group-item d-flex justify-content-between">${x} <button onclick="this.parentElement.remove();updt('avForca','listaForca')" class="btn btn-sm btn-outline-danger">X</button></li>`).join(''); }
                if(d.testes_especiais) { document.getElementById('listaTestes').innerHTML = d.testes_especiais.split('\n').filter(x=>x).map(x=>`<li class="list-group-item d-flex justify-content-between">${x} <button onclick="this.parentElement.remove();updt('avTestes','listaTestes')" class="btn btn-sm btn-outline-secondary">X</button></li>`).join(''); }
                try{let s=JSON.parse(d.sinais_vitais);document.getElementById('sinPA').value=s.pa;document.getElementById('sinFC').value=s.fc;document.getElementById('sinSpO2').value=s.spo2;document.getElementById('sinTemp').value=s.temp;}catch(e){}
                try{let o=JSON.parse(d.avaliacao_dor);document.getElementById('dorEVA').value=o.eva;document.getElementById('dorLocal').value=o.local;document.getElementById('dorTipo').value=o.tipo;document.getElementById('dorPiora').value=o.piora;document.getElementById('dorAlivio').value=o.alivia;}catch(e){}
                document.getElementById('dataUltimaAvaliacao').innerText = "Salvo em: " + d.data;
            }
        });
    }
    
    function processarImagem(i,m,c){ if(i.files[0]){var r=new FileReader();r.onload=function(e){var img=new Image();img.src=e.target.result;img.onload=function(){var cv=document.createElement('canvas');var ctx=cv.getContext('2d');var rt=Math.min(600/img.width,1);cv.width=img.width*rt;cv.height=img.height*rt;ctx.drawImage(img,0,0,cv.width,cv.height);document.getElementById(m).src=cv.toDataURL('image/jpeg',0.7);document.getElementById(m).classList.remove('d-none');}};r.readAsDataURL(i.files[0]);}}
    function salvarFotos(){ const id=document.getElementById('idPacienteProntuario').value; const d={paciente_id:id, frontal:document.getElementById('imgFrontal').src, posterior:document.getElementById('imgPosterior').src, lat_dir:document.getElementById('imgLatDir').src, lat_esq:document.getElementById('imgLatEsq').src, analise_ia:document.getElementById('analiseIA').value}; if(d.frontal.length<100)return alert('Foto?'); fetch('/api/salvar_fotos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).then(()=>alert('Fotos Salvas')); }
    const v=document.getElementById('btnVoiceEvo');if(v)v.addEventListener('click',()=>{const r=new webkitSpeechRecognition();r.lang='pt-BR';r.start();r.onresult=(e)=>{document.getElementById('textoEvolucao').value+=e.results[0][0].transcript+'. '}});
</script>
{% endblock %}