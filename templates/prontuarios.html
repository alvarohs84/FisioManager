{% extends "layout.html" %}

{% block content %}
<div class="container-fluid px-4">
    <h2 class="mt-4 mb-4 fw-bold text-primary"><i class="bi bi-folder2-open me-2"></i>Prontuários Eletrônicos</h2>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush rounded-4 overflow-hidden">
                        {% for p in pacientes %}
                        <button type="button" class="list-group-item list-group-item-action p-4 d-flex align-items-center justify-content-between transition-hover" 
                                onclick="abrirProntuario({{ p[0] }}, '{{ p[1] }}')">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-primary text-white fw-bold fs-4 d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                    {{ p[1][0] | upper }}
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold text-dark">{{ p[1] }}</h5>
                                    <small class="text-muted"><i class="bi bi-calendar-event me-1"></i> Nascimento: {{ p[2].strftime('%d/%m/%Y') if p[2] else 'N/D' }}</small>
                                </div>
                            </div>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </button>
                        {% else %}
                        <div class="p-5 text-center text-muted">
                            <i class="bi bi-people fs-1 mb-2"></i>
                            <p>Nenhum paciente encontrado.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalProntuario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-light">
            <div class="modal-header bg-primary text-white py-2">
                <div class="d-flex align-items-center">
                    <i class="bi bi-person-vcard fs-3 me-3"></i>
                    <div>
                        <small class="opacity-75 d-block">Paciente</small>
                        <h5 class="modal-title fw-bold" id="lblNomePaciente">Carregando...</h5>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="d-flex h-100 flex-column flex-lg-row">
                    <div class="bg-white border-end col-lg-2 col-12">
                        <div class="nav flex-column nav-pills p-3" id="v-pills-tab" role="tablist">
                            <button class="nav-link active text-start mb-2 rounded-3 py-3" data-bs-toggle="pill" data-bs-target="#tab-evolucao"><i class="bi bi-clock-history me-2"></i> Evolução</button>
                            <button class="nav-link text-start mb-2 rounded-3 py-3" data-bs-toggle="pill" data-bs-target="#tab-avaliacao"><i class="bi bi-file-medical me-2"></i> Avaliação Físio</button>
                            <button class="nav-link text-start mb-2 rounded-3 py-3" data-bs-toggle="pill" data-bs-target="#tab-cardio"><i class="bi bi-lungs me-2"></i> Cardiopulmonar</button>
                            <button class="nav-link text-start mb-2 rounded-3 py-3" data-bs-toggle="pill" data-bs-target="#tab-pilates"><i class="bi bi-person-arms-up me-2"></i> Pilates</button>
                            <button class="nav-link text-start mb-2 rounded-3 py-3" data-bs-toggle="pill" data-bs-target="#tab-quiro"><i class="bi bi-hand-index-thumb me-2"></i> Quiro / T. Manual</button>
                            <button class="nav-link text-start mb-2 rounded-3 py-3" data-bs-toggle="pill" data-bs-target="#tab-fotos"><i class="bi bi-images me-2"></i> Fotos</button>
                        </div>
                    </div>

                    <div class="col-lg-10 col-12 bg-light overflow-auto p-4" style="height: calc(100vh - 70px);">
                        <input type="hidden" id="idPacienteAtual">
                        <div class="tab-content">
                            
                            <div class="tab-pane fade show active" id="tab-evolucao">
                                <div class="card border-0 shadow-sm rounded-4 mb-4">
                                    <div class="card-body">
                                        <h5 class="fw-bold text-primary mb-3">Nova Evolução</h5>
                                        <textarea class="form-control bg-light border-0 rounded-3 p-3 mb-3" id="txtEvolucao" rows="4"></textarea>
                                        <div class="text-end"><button onclick="salvarEvolucao()" class="btn btn-primary rounded-pill px-4">Salvar</button></div>
                                    </div>
                                </div>
                                <div id="listaEvolucoes"></div>
                            </div>

                            <div class="tab-pane fade" id="tab-avaliacao">
                                <div class="container p-0" style="max-width: 900px;">
                                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                                        <div class="card-header bg-white border-0 py-3"><h5 class="fw-bold text-primary mb-0">Anamnese</h5></div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6"><label class="small text-muted">Ocupação</label><input type="text" id="av_ocupacao" class="form-control bg-light border-0"></div>
                                                <div class="col-md-6"><label class="small text-muted">Diagnóstico</label><input type="text" id="av_diag_medico" class="form-control bg-light border-0"></div>
                                                <div class="col-12"><label class="small text-muted">Queixa Principal</label><textarea id="av_qp" class="form-control bg-light border-0"></textarea></div>
                                                <div class="col-12"><label class="small text-muted">HDA</label><textarea id="av_hma" class="form-control bg-light border-0"></textarea></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                                        <div class="card-header bg-white border-0 py-3"><h5 class="fw-bold text-danger mb-0">Comorbidades (HPP)</h5></div>
                                        <div class="card-body">
                                            <div class="mb-2"><small class="text-muted">Selecione:</small></div>
                                            <div class="row g-2">
                                                <div class="col-md-3"><div class="form-check"><input class="form-check-input check-hpp" type="checkbox" value="HAS"><label>Hipertensão</label></div></div>
                                                <div class="col-md-3"><div class="form-check"><input class="form-check-input check-hpp" type="checkbox" value="Diabetes"><label>Diabetes</label></div></div>
                                                <div class="col-md-3"><div class="form-check"><input class="form-check-input check-hpp" type="checkbox" value="Asma"><label>Asma</label></div></div>
                                                <div class="col-md-3"><div class="form-check"><input class="form-check-input check-hpp" type="checkbox" value="Hernia"><label>Hérnia Discal</label></div></div>
                                            </div>
                                            <textarea id="av_hpp_texto" class="form-control bg-light border-0 mt-3" placeholder="Outras observações..."></textarea>
                                        </div>
                                    </div>

                                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                                        <div class="card-header bg-white border-0 py-3"><h5 class="fw-bold text-success mb-0">Exame Físico</h5></div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-12"><label class="small text-muted">Sinais Vitais</label><input id="av_sinais" class="form-control bg-light border-0"></div>
                                                <div class="col-md-6"><label class="small text-muted">Inspeção</label><textarea id="av_inspecao" class="form-control bg-light border-0"></textarea></div>
                                                <div class="col-md-6"><label class="small text-muted">Palpação</label><textarea id="av_palpacao" class="form-control bg-light border-0"></textarea></div>
                                                <div class="col-md-6"><label class="small text-muted">ADM</label><textarea id="av_adm" class="form-control bg-light border-0"></textarea></div>
                                                <div class="col-md-6"><label class="small text-muted">Testes</label><textarea id="av_testes" class="form-control bg-light border-0"></textarea></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card border-0 shadow-sm rounded-4 mb-5">
                                        <div class="card-header bg-white border-0 py-3"><h5 class="fw-bold text-dark mb-0">Conclusão</h5></div>
                                        <div class="card-body">
                                            <div class="mb-2"><label class="small text-muted">CIF</label><textarea id="av_cif" class="form-control bg-light border-0"></textarea></div>
                                            <div class="mb-2"><label class="small text-muted">Objetivos</label><textarea id="av_objetivos" class="form-control bg-light border-0"></textarea></div>
                                            <div class="mb-2"><label class="small text-muted">Conduta</label><textarea id="av_conduta" class="form-control bg-light border-0"></textarea></div>
                                        </div>
                                    </div>
                                    <div class="text-end mb-5"><button onclick="salvarAvaliacaoCompleta()" class="btn btn-success rounded-pill px-5">Salvar Tudo</button></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-cardio">
                                <div class="card border-0 shadow-sm rounded-4 mb-4">
                                    <div class="card-header bg-white border-0 py-3"><h5 class="fw-bold text-danger mb-0"><i class="bi bi-lungs me-2"></i>Cardiopulmonar</h5></div>
                                    <div class="card-body">
                                        <div class="bg-light p-4 rounded-4 mb-4 border">
                                            <h6 class="fw-bold text-danger mb-3">Teste de Caminhada (TC6)</h6>
                                            <div class="row g-3">
                                                <div class="col-md-3"><label class="small fw-bold text-muted">Distância (m)</label><input type="number" id="tc6_distancia" class="form-control border-0"></div>
                                                <div class="col-md-3"><label class="small fw-bold text-muted">Paradas</label><input type="number" id="tc6_paradas" class="form-control border-0"></div>
                                                <div class="col-md-6">
                                                    <label class="small fw-bold text-muted">O2 Suplementar</label>
                                                    <div class="d-flex align-items-center bg-white p-2 rounded border">
                                                        <div class="form-check form-switch ms-2"><input class="form-check-input" type="checkbox" id="tc6_usa_o2" onchange="toggleO2Input()"><label class="small fw-bold ms-1" for="tc6_usa_o2">Usou?</label></div>
                                                        <div class="ms-3 d-none align-items-center" id="div_litragem"><input type="number" step="0.5" id="tc6_litros" class="form-control form-control-sm border-secondary p-0 text-center" style="width: 50px;"><span class="small text-muted ms-1">L/min</span></div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3"><label class="small fw-bold text-muted">Borg (Dispneia)</label><input type="number" step="0.5" id="tc6_borg_dispneia" class="form-control border-0" placeholder="0-10"></div>
                                                <div class="col-md-3"><label class="small fw-bold text-muted">Borg (MMII)</label><input type="number" step="0.5" id="tc6_borg_mmii" class="form-control border-0" placeholder="0-10"></div>
                                                <div class="col-md-6"><label class="small fw-bold text-muted">Sinais Finais (SpO2/FC/PA)</label><input type="text" id="tc6_sinais" class="form-control border-0"></div>
                                            </div>
                                        </div>
                                        <div class="row g-3 mb-4">
                                            <div class="col-md-6"><label class="small fw-bold text-muted">MRC (Dispneia)</label><input type="text" id="cardio_mrc" class="form-control bg-light border-0"></div>
                                            <div class="col-md-6"><label class="small fw-bold text-muted">Espirometria</label><input type="text" id="cardio_espiro" class="form-control bg-light border-0"></div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold small text-muted">Zona de Treinamento / Histórico</label>
                                            <textarea id="cardio_treino" class="form-control bg-light border-0" rows="5"></textarea>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-3"><div class="form-check border p-2 rounded"><input class="form-check-input check-cardio" type="checkbox" value="Esteira"><label class="ms-1">Esteira</label></div></div>
                                            <div class="col-md-3"><div class="form-check border p-2 rounded"><input class="form-check-input check-cardio" type="checkbox" value="Ciclo"><label class="ms-1">Ciclo</label></div></div>
                                            <div class="col-md-3"><div class="form-check border p-2 rounded"><input class="form-check-input check-cardio" type="checkbox" value="VNI"><label class="ms-1">VNI</label></div></div>
                                            <div class="col-md-3"><div class="form-check border p-2 rounded"><input class="form-check-input check-cardio" type="checkbox" value="TMI"><label class="ms-1">TMI</label></div></div>
                                        </div>
                                    </div>
                                    <div class="text-end mb-3 me-3"><button onclick="salvarAvaliacaoCompleta()" class="btn btn-success rounded-pill px-4">Salvar</button></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-pilates">
                                <div class="card border-0 shadow-sm rounded-4 mb-4">
                                    <div class="card-header bg-white border-0 py-3"><h5 class="fw-bold text-success mb-0"><i class="bi bi-person-arms-up me-2"></i>Pilates</h5></div>
                                    <div class="card-body">
                                        <div class="row g-3 mb-4">
                                            <div class="col-4"><div class="form-check border p-2 rounded"><input class="form-check-input check-pilates" type="checkbox" value="Solo"><label>Solo</label></div></div>
                                            <div class="col-4"><div class="form-check border p-2 rounded"><input class="form-check-input check-pilates" type="checkbox" value="Bola"><label>Bola</label></div></div>
                                            <div class="col-4"><div class="form-check border p-2 rounded"><input class="form-check-input check-pilates" type="checkbox" value="Reformer"><label>Reformer</label></div></div>
                                            <div class="col-4"><div class="form-check border p-2 rounded"><input class="form-check-input check-pilates" type="checkbox" value="Cadillac"><label>Cadillac</label></div></div>
                                            <div class="col-4"><div class="form-check border p-2 rounded"><input class="form-check-input check-pilates" type="checkbox" value="Chair"><label>Chair</label></div></div>
                                            <div class="col-4"><div class="form-check border p-2 rounded"><input class="form-check-input check-pilates" type="checkbox" value="Barrel"><label>Barrel</label></div></div>
                                        </div>
                                        <textarea id="pilates_exercicios" class="form-control bg-light border-0" rows="5" placeholder="Exercícios..."></textarea>
                                    </div>
                                    <div class="text-end mb-3 me-3"><button onclick="salvarAvaliacaoCompleta()" class="btn btn-success rounded-pill px-4">Salvar</button></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-quiro">
                                <div class="card border-0 shadow-sm rounded-4 mb-4">
                                    <div class="card-header bg-white border-0 py-3"><h5 class="fw-bold text-primary mb-0"><i class="bi bi-hand-index-thumb me-2"></i>Quiropraxia</h5></div>
                                    <div class="card-body">
                                        <div class="d-flex flex-wrap gap-2 mb-4">
                                            <div class="form-check"><input class="form-check-input check-quiro" type="checkbox" value="Cervical"><label>Cervical</label></div>
                                            <div class="form-check"><input class="form-check-input check-quiro" type="checkbox" value="Torácica"><label>Torácica</label></div>
                                            <div class="form-check"><input class="form-check-input check-quiro" type="checkbox" value="Lombar"><label>Lombar</label></div>
                                            <div class="form-check"><input class="form-check-input check-quiro" type="checkbox" value="Sacro"><label>Sacro</label></div>
                                        </div>
                                        <div class="row g-2 mb-4">
                                            <div class="col-4"><div class="form-check"><input class="form-check-input check-quiro-tec" type="checkbox" value="Trust"><label>Trust</label></div></div>
                                            <div class="col-4"><div class="form-check"><input class="form-check-input check-quiro-tec" type="checkbox" value="Miofascial"><label>Miofascial</label></div></div>
                                            <div class="col-4"><div class="form-check"><input class="form-check-input check-quiro-tec" type="checkbox" value="Dry Needling"><label>Dry Needling</label></div></div>
                                        </div>
                                        <textarea id="quiro_obs" class="form-control bg-light border-0" rows="5" placeholder="Conduta..."></textarea>
                                    </div>
                                    <div class="text-end mb-3 me-3"><button onclick="salvarAvaliacaoCompleta()" class="btn btn-success rounded-pill px-4">Salvar</button></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-fotos">
                                <div class="text-center py-5"><i class="bi bi-camera fs-1 text-muted"></i><p>Fotos em breve.</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function abrirProntuario(id, nome) {
        document.getElementById('idPacienteAtual').value = id;
        document.getElementById('lblNomePaciente').innerText = nome;
        new bootstrap.Modal(document.getElementById('modalProntuario')).show();
        carregarEvolucoes(id);
        carregarAvaliacao(id);
    }

    function toggleO2Input() {
        const check = document.getElementById('tc6_usa_o2');
        const div = document.getElementById('div_litragem');
        if(check.checked) { div.classList.remove('d-none'); div.classList.add('d-flex'); }
        else { div.classList.add('d-none'); div.classList.remove('d-flex'); document.getElementById('tc6_litros').value = ''; }
    }

    function carregarEvolucoes(id) {
        fetch(`/api/evolucoes/${id}`).then(r => r.json()).then(data => {
            const l = document.getElementById('listaEvolucoes'); l.innerHTML = '';
            data.forEach(e => l.innerHTML += `<div class="card mb-2 shadow-sm"><div class="card-body py-2"><small class="fw-bold">${e.data}</small><p class="m-0">${e.texto}</p></div></div>`);
        });
    }

    function salvarEvolucao() {
        const id = document.getElementById('idPacienteAtual').value, txt = document.getElementById('txtEvolucao').value;
        if(!txt) return alert("Vazio!");
        fetch('/api/nova_evolucao', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({paciente_id: id, texto: txt}) })
        .then(() => { document.getElementById('txtEvolucao').value = ''; carregarEvolucoes(id); });
    }

    function carregarAvaliacao(id) {
        fetch(`/api/get_avaliacao/${id}`).then(r => r.json()).then(d => {
            if(d.encontrado) {
                document.getElementById('av_ocupacao').value = d.ocupacao || '';
                document.getElementById('av_diag_medico').value = d.diagnostico_medico || '';
                document.getElementById('av_qp').value = d.queixa_principal || '';
                document.getElementById('av_hma').value = d.hma || '';
                document.getElementById('av_hpp_texto').value = d.hpp || '';
                document.getElementById('av_sinais').value = d.sinais_vitais || '';
                document.getElementById('av_inspecao').value = d.inspecao || '';
                document.getElementById('av_palpacao').value = d.avaliacao_dor || '';
                document.getElementById('av_adm').value = d.adm || '';
                document.getElementById('av_testes').value = d.testes_especiais || '';
                document.getElementById('av_cif').value = d.diagnostico_cif || '';
                document.getElementById('av_objetivos').value = d.objetivos || '';
                document.getElementById('av_conduta').value = d.conduta || '';
                
                document.getElementById('pilates_exercicios').value = d.dados_pilates || '';
                document.getElementById('quiro_obs').value = d.dados_quiro || '';
                
                // Cardio
                if(d.dados_cardio) document.getElementById('cardio_treino').value = "--- ÚLTIMO REGISTRO ---\n" + d.dados_cardio + "\n-----------------------\n";
                else document.getElementById('cardio_treino').value = "";
                
                // Limpa campos numéricos do TC6
                document.getElementById('tc6_distancia').value = '';
                document.getElementById('tc6_paradas').value = '';
                document.getElementById('tc6_borg_dispneia').value = ''; // Limpa novo campo
                document.getElementById('tc6_borg_mmii').value = ''; // Limpa novo campo
                document.getElementById('tc6_sinais').value = '';
                document.getElementById('tc6_usa_o2').checked = false; toggleO2Input();
            } else {
                document.querySelectorAll('input, textarea').forEach(e => e.value = '');
                document.querySelectorAll('input[type=checkbox]').forEach(e => e.checked = false);
            }
        });
    }

    function salvarAvaliacaoCompleta() {
        const id = document.getElementById('idPacienteAtual').value;
        let hpp = []; document.querySelectorAll('.check-hpp:checked').forEach(e => hpp.push(e.value));
        const hppFinal = "Items: " + hpp.join(", ") + ". Obs: " + document.getElementById('av_hpp_texto').value;

        let pilates = []; document.querySelectorAll('.check-pilates:checked').forEach(e => pilates.push(e.value));
        const pilatesFinal = "Aparelhos: " + pilates.join(", ") + " | " + document.getElementById('pilates_exercicios').value;

        let quiro = []; document.querySelectorAll('.check-quiro:checked').forEach(e => quiro.push(e.value));
        let quiroTec = []; document.querySelectorAll('.check-quiro-tec:checked').forEach(e => quiroTec.push(e.value));
        const quiroFinal = "Reg: " + quiro.join(", ") + " | Tec: " + quiroTec.join(", ") + " | " + document.getElementById('quiro_obs').value;

        let cardioEq = []; document.querySelectorAll('.check-cardio:checked').forEach(e => cardioEq.push(e.value));
        const usaO2 = document.getElementById('tc6_usa_o2').checked;
        const cardioFinal = `TC6: ${document.getElementById('tc6_distancia').value}m | Paradas: ${document.getElementById('tc6_paradas').value} | O2: ${usaO2 ? document.getElementById('tc6_litros').value + 'L' : 'Não'} | Borg Disp: ${document.getElementById('tc6_borg_dispneia').value} | Borg MMII: ${document.getElementById('tc6_borg_mmii').value} | Sinais: ${document.getElementById('tc6_sinais').value} | MRC: ${document.getElementById('cardio_mrc').value} | Espiro: ${document.getElementById('cardio_espiro').value} | Eq: ${cardioEq.join(", ")} | Treino: ${document.getElementById('cardio_treino').value}`;

        const dados = {
            paciente_id: id,
            ocupacao: document.getElementById('av_ocupacao').value, lateralidade: "Destro", diagnostico_medico: document.getElementById('av_diag_medico').value, queixa_principal: document.getElementById('av_qp').value, hma: document.getElementById('av_hma').value, hpp: hppFinal, habitos: "", sinais_vitais: document.getElementById('av_sinais').value, avaliacao_dor: document.getElementById('av_palpacao').value, inspecao: document.getElementById('av_inspecao').value, palpacao: "Ver dor", adm: document.getElementById('av_adm').value, forca_muscular: "", neuro: "", testes_especiais: document.getElementById('av_testes').value, diagnostico_cif: document.getElementById('av_cif').value, objetivos: document.getElementById('av_objetivos').value, conduta: document.getElementById('av_conduta').value,
            dados_pilates: pilatesFinal, dados_quiro: quiroFinal, dados_cardio: cardioFinal
        };

        fetch('/api/salvar_avaliacao', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) })
        .then(r => r.json()).then(res => { if(res.status==='success') alert('Salvo!'); else alert('Erro: '+res.msg); });
    }
</script>
{% endblock %}