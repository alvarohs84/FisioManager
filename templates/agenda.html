{% extends "layout.html" %}

{% block content %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales-all.global.min.js'></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="brand-title"><i class="bi bi-calendar-week text-primary me-2"></i> Agenda Inteligente</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#eventModal">
        <i class="bi bi-plus-lg"></i> Novo Agendamento
    </button>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div id='calendar'></div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">Agendar Sess√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAgendamento">
                    <div class="mb-3">
                        <label class="form-label">Paciente</label>
                        <select id="pacienteId" class="form-select" required>
                            <option value="">Selecione...</option>
                            {% for p in pacientes %}
                                <option value="{{ p[0] }}">{{ p[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Data In√≠cio</label>
                            <input type="datetime-local" id="startDateTime" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observa√ß√µes</label>
                        <div class="input-group">
                            <textarea id="obs" class="form-control" rows="2"></textarea>
                            <button class="btn btn-outline-secondary" type="button" id="btnVoice"><i class="bi bi-mic-fill"></i></button>
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-primary"><i class="bi bi-arrow-repeat"></i> Repetir Atendimento?</label>
                        <div class="d-flex justify-content-between mt-2 flex-wrap">
                            <div class="form-check me-2"><input class="form-check-input dia-rec" type="checkbox" value="0"><label>Seg</label></div>
                            <div class="form-check me-2"><input class="form-check-input dia-rec" type="checkbox" value="1"><label>Ter</label></div>
                            <div class="form-check me-2"><input class="form-check-input dia-rec" type="checkbox" value="2"><label>Qua</label></div>
                            <div class="form-check me-2"><input class="form-check-input dia-rec" type="checkbox" value="3"><label>Qui</label></div>
                            <div class="form-check me-2"><input class="form-check-input dia-rec" type="checkbox" value="4"><label>Sex</label></div>
                            <div class="form-check me-2"><input class="form-check-input dia-rec" type="checkbox" value="5"><label class="text-primary fw-bold">S√°b</label></div>
                        </div>
                        <div class="mt-2">
                            <label class="form-label">Por quantas semanas?</label>
                            <input type="number" id="semanasRec" class="form-control" value="1" min="1" max="12">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarEvento()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Detalhes do Agendamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editEventId">
                <h4 id="editEventTitle" class="mb-3"></h4>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Status da Sess√£o</label>
                    <select id="editEventStatus" class="form-select">
                        <option value="Agendado">üìÖ Agendado (Azul)</option>
                        <option value="Confirmado">‚úÖ Confirmado (Turquesa)</option>
                        <option value="Realizado">üí∞ Realizado (Verde)</option>
                        <option value="Faltou">‚ùå Faltou (Vermelho)</option>
                        <option value="Cancelado">üö´ Cancelado (Cinza)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea id="editEventObs" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-danger" onclick="deletarEventoAtual()">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" onclick="salvarEdicao()">
                        <i class="bi bi-check-lg"></i> Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var calendar; 

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: 'pt-br',
            buttonText: { today: 'Hoje', month: 'M√™s', week: 'Semana', day: 'Dia', list: 'Lista' },
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            slotMinTime: "07:00:00",
            slotMaxTime: "20:00:00",
            allDaySlot: false,
            editable: true,
            selectable: true, 
            events: '/api/eventos',
            
            // Clicar em vazio -> Criar
            dateClick: function(info) {
                document.getElementById('startDateTime').value = info.dateStr.substring(0, 16);
                var modal = new bootstrap.Modal(document.getElementById('eventModal'));
                modal.show();
            },
            
            // Arrastar -> Mover
            eventDrop: function(info) {
                fetch('/api/mover_evento', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id: info.event.id,
                        start: info.event.start.toISOString(),
                        end: info.event.end.toISOString()
                    })
                });
            },
            
            // Clicar no evento -> Editar / Checar Status
            eventClick: function(info) {
                // Preenche o Modal de Edi√ß√£o
                document.getElementById('editEventId').value = info.event.id;
                document.getElementById('editEventTitle').innerText = info.event.title.split('(')[0]; // Tira o status do titulo
                document.getElementById('editEventObs').value = info.event.extendedProps.description || '';
                
                // Seleciona o status correto
                var statusAtual = info.event.extendedProps.status || 'Agendado';
                document.getElementById('editEventStatus').value = statusAtual;

                // Abre o Modal
                var modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            }
        });
        calendar.render();
    });

    // Salvar Novo
    function salvarEvento() {
        var pacienteId = document.getElementById('pacienteId').value;
        var start = document.getElementById('startDateTime').value;
        var obs = document.getElementById('obs').value;
        var semanas = document.getElementById('semanasRec').value;
        var dias = [];
        document.querySelectorAll('.dia-rec:checked').forEach((cb) => { dias.push(cb.value); });

        if (!pacienteId || !start) return alert("Preencha o paciente e a data!");

        fetch('/api/criar_evento', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ paciente_id: pacienteId, start: start, obs: obs, dias_recorrentes: dias, semanas: semanas })
        }).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            calendar.refetchEvents();
            alert("Agendado!");
        });
    }

    // Salvar Edi√ß√£o (Status/Obs)
    function salvarEdicao() {
        var id = document.getElementById('editEventId').value;
        var status = document.getElementById('editEventStatus').value;
        var obs = document.getElementById('editEventObs').value;

        fetch('/api/atualizar_evento', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: id, status: status, obs: obs })
        }).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            calendar.refetchEvents(); // Atualiza cor
        });
    }

    // Excluir do Modal de Edi√ß√£o
    function deletarEventoAtual() {
        if(!confirm("Tem certeza que deseja excluir?")) return;
        var id = document.getElementById('editEventId').value;
        fetch('/api/deletar_evento', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: id })
        }).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            calendar.refetchEvents();
        });
    }

    // Voz
    const btnVoice = document.getElementById('btnVoice');
    const txtObs = document.getElementById('obs');
    if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'pt-BR';
        recognition.continuous = false;
        btnVoice.addEventListener('click', () => { recognition.start(); btnVoice.classList.add('btn-danger'); });
        recognition.onresult = (e) => { txtObs.value += e.results[0][0].transcript + ". "; btnVoice.classList.remove('btn-danger'); };
    } else { btnVoice.style.display = 'none'; }
</script>

<style>
    .fc-event { cursor: pointer; border: none; }
    #calendar { padding: 20px; min-height: 80vh; }
    .fc-button-primary { background-color: #007bff !important; border-color: #007bff !important; }
</style>
{% endblock %}